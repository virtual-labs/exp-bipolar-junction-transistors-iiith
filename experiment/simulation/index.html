<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BJT Interactive Physics Lab - Enhanced Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 6px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .experiment-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background: #f8fafc;
            border-radius: 10px;
            padding: 6px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #6b7280;
            margin: 2px;
        }

        .tab.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .experiment-content {
            display: none;
        }

        .experiment-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 15px;
        }

        .visualization-area {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .full-width-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .graph-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .graph-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .graph-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f5f9;
        }

        .graph-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bjt-structure {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f8fafc, #e2e8f0);
            border-radius: 12px;
            border: 2px solid #cbd5e1;
            overflow: hidden;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .bjt-layer {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .emitter-region {
            width: 25%;
            height: 100%;
            left: 0;
            top: 0;
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
            border-radius: 12px 0 0 12px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .base-region {
            width: 15%;
            height: 100%;
            left: 25%;
            top: 0;
            background: linear-gradient(135deg, #10b981, #059669, #047857);
            z-index: 2;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .collector-region {
            width: 60%;
            height: 100%;
            left: 40%;
            top: 0;
            background: linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8);
            border-radius: 0 12px 12px 0;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .current-flow {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .current-arrow {
            position: absolute;
            width: 0;
            height: 0;
            transition: all 0.5s ease;
            opacity: 0;
            z-index: 8;
        }

        .current-arrow.active {
            opacity: 1;
            animation: pulse-arrow 1.5s ease-in-out infinite;
        }

        .electron-flow {
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #3b82f6;
            filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.8));
        }

        .hole-flow {
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 20px solid #ef4444;
            filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.8));
        }

        @keyframes pulse-arrow {
            0%, 100% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.8)); 
            }
            50% { 
                transform: scale(1.2); 
                filter: drop-shadow(0 0 12px rgba(59, 130, 246, 1)); 
            }
        }

        .carrier-animation {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: carrier-flow 2s ease-in-out infinite;
            z-index: 5;
        }

        .electron {
            background: radial-gradient(circle, #3b82f6, #1d4ed8);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.8), inset 0 0 6px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .hole {
            background: radial-gradient(circle, #ef4444, #dc2626);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.8), inset 0 0 6px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        @keyframes carrier-flow {
            0% { 
                transform: translateX(0) translateY(0) scale(0.8); 
                opacity: 0.7; 
            }
            25% { 
                transform: translateX(100px) translateY(-5px) scale(1.1); 
                opacity: 0.9; 
            }
            50% { 
                transform: translateX(200px) translateY(0) scale(1.2); 
                opacity: 1; 
            }
            75% { 
                transform: translateX(300px) translateY(5px) scale(1.1); 
                opacity: 0.8; 
            }
            100% { 
                transform: translateX(400px) translateY(0) scale(0.8); 
                opacity: 0.3; 
            }
        }

        @keyframes carrier-flow-reverse {
            0% { 
                transform: translateX(400px) translateY(0) scale(0.8); 
                opacity: 0.3; 
            }
            25% { 
                transform: translateX(300px) translateY(5px) scale(1.1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translateX(200px) translateY(0) scale(1.2); 
                opacity: 1; 
            }
            75% { 
                transform: translateX(100px) translateY(-5px) scale(1.1); 
                opacity: 0.9; 
            }
            100% { 
                transform: translateX(0) translateY(0) scale(0.8); 
                opacity: 0.7; 
            }
        }

        .voltage-indicators {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .voltage-label {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .status-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .status-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .status-card.active {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
        }

        .status-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-top: 3px;
        }

        .mode-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mode-cutoff {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .mode-active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .mode-saturation {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .mode-reverse {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .control-input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, #e2e8f0, #cbd5e1);
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            border: 2px solid white;
        }

        .value-display {
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-align: center;
            margin-top: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            min-height: 14px;
            font-size: 0.8rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            width: 100%;
            margin: 5px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .measurements-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .measurements-section h3 {
            margin-bottom: 10px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .measurement-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .measurement-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .measurement-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .alert {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .alert-info {
            background: #eff6ff;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        /* Static graph styling */
        .static-graph-small {
            height: 350px;
            width: 100%;
        }

        /* Floating Buttons */
        .floating-button {
            position: fixed;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }

        .floating-button.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            bottom: 2rem;
            right: 2rem;
        }

        .floating-button.tour {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            bottom: 2rem;
            right: 6.5rem;
        }

        .floating-panel {
            position: fixed;
            max-width: 18rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 99;
            bottom: 7rem;
            right: 2rem;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem;
        }

        .floating-panel.active {
            transform: scale(1);
            opacity: 1;
        }

        .floating-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .floating-panel-close {
            cursor: pointer;
            color: #6b7280;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-panel-content {
            max-height: calc(80vh - 3rem);
            overflow-y: auto;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin: 0;
        }

        /* GUIDED TOUR STYLES */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0); /* Completely transparent background */
            z-index: 99998;
            display: none;
            pointer-events: none; /* Allow interaction with elements underneath */
        }

        .tour-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .tour-spotlight {
            position: absolute;
            background: transparent;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            transition: all 0.5s ease;
            z-index: 99999;
            pointer-events: none; /* Allow interaction with elements inside spotlight */
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            animation: spotlight-pulse 2s ease-in-out infinite;
        }

        @keyframes spotlight-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 12px rgba(59, 130, 246, 0);
                transform: scale(1.02);
            }
        }

        .tour-spotlight-secondary {
            position: absolute;
            background: transparent;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            transition: all 0.5s ease;
            z-index: 99999;
            pointer-events: none;
            box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
            animation: secondary-pulse 2s ease-in-out infinite;
        }

        @keyframes secondary-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
                transform: scale(1.01);
            }
        }

        .tour-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100000;
            min-width: 300px;
            max-width: 450px;
            transform: scale(0.8);
            opacity: 0.9; /* Make slightly transparent */
            pointer-events: auto; /* Ensure popup buttons are clickable */
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .tour-popup.active {
            transform: scale(1);
            opacity: 1;
        }

        .tour-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .tour-step-number {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }

        .tour-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .tour-content {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .tour-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
        }

        .tour-challenge {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .tour-challenge-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .tour-challenge-title i {
            margin-right: 8px;
        }

        .tour-challenge-content {
            color: #78350f;
            font-size: 0.9rem;
        }

        .tour-progress {
            background: #f3f4f6;
            height: 6px;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .tour-progress-bar {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            height: 100%;
            transition: width 0.5s ease;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .tour-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .tour-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .tour-btn:hover {
            transform: translateY(-1px);
        }

        .tour-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tour-concept {
            background: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #0369a1;
        }

        .tour-concept-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .highlight-element {
            animation: pulse-highlight 2s ease-in-out 3;
        }

        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1f2937;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Waveform Simulation Styles */
        .waveform-simulation {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e2e8f0;
        }

        .waveform-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .waveform-panel {
            background: #1f2937;
            border-radius: 8px;
            padding: 12px;
            color: white;
            height: 220px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .waveform-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e5e7eb;
            text-align: center;
        }

        .waveform-canvas {
            width: 100%;
            height: 160px;
            max-width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .simulation-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .control-row {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .control-row input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }

        /* Circuit Image Styles */
        .circuit-image-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 10px;
            overflow: hidden;
        }

        .circuit-image-container:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        }

        .circuit-image-container.has-image {
            min-height: 400px;
        }

        .circuit-placeholder {
            text-align: center;
            color: #6b7280;
            padding: 40px;
        }

        .circuit-placeholder i {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .circuit-placeholder h4 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #374151;
        }

        .circuit-placeholder p {
            font-size: 1rem;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto 20px auto;
        }

        .circuit-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .upload-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .file-input {
            display: none;
        }

        .image-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 8px;
        }

        .circuit-image-container.has-image .image-controls {
            display: flex;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }

        .control-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .upload-instructions {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .upload-instructions h4 {
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .upload-instructions ul {
            color: #1e40af;
            padding-left: 20px;
        }

        .upload-instructions li {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        /* Challenge System Styles */
        .challenge-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .challenge-section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .challenge-section:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .challenge-section.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .challenge-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .challenge-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .challenge-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .challenge-stats {
            display: flex;
            justify-content: space-around;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .challenge-progress {
            background: #f3f4f6;
            border-radius: 8px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .challenge-progress-bar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }

        .quiz-question {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #6366f1;
        }

        .quiz-question h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1rem;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
        }

        .quiz-option:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }

        .quiz-option.selected {
            border-color: #6366f1;
            background: #eff6ff;
            color: #1e40af;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #f0fdf4;
            color: #065f46;
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }

        .fill-blank-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #8b5cf6;
        }

        .fill-blank-text {
            font-size: 1rem;
            line-height: 2;
            color: #1f2937;
        }

        .fill-blank-input {
            display: inline-block;
            width: 120px;
            padding: 4px 8px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            margin: 0 5px;
            background: white;
        }

        .fill-blank-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .fill-blank-input.correct {
            border-color: #10b981;
            background: #f0fdf4;
            color: #065f46;
        }

        .fill-blank-input.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }

        .matching-container {
            display: grid;
            grid-template-columns: 1fr 50px 1fr;
            gap: 20px;
            align-items: start;
        }
        
        .matching-column {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .matching-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: center;
        }
        
        .matching-item:hover {
            border-color: #6366f1;
            transform: translateX(5px);
        }
        
        .matching-item.selected {
            border-color: #6366f1;
            background: #eff6ff;
            transform: scale(1.02);
        }
        
        .matching-item.matched {
            border-color: #6366f1;
            background: #eff6ff;
            opacity: 0.9;
        }
        
        .matching-item.correct-match {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .matching-item.incorrect-match {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .matching-connections {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .connection-line {
            position: absolute;
            background: #6366f1;
            height: 3px;
            border-radius: 2px;
            opacity: 0.8;
            z-index: 1;
            transform-origin: left;
        }

        .challenge-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .challenge-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .challenge-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .challenge-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .challenge-btn:hover {
            transform: translateY(-2px);
        }

        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .challenge-feedback {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .challenge-feedback.success {
            background: #f0fdf4;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }

        .challenge-feedback.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }

        .explanation-panel {
            background: #f0f9ff;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .explanation-panel.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .explanation-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .explanation-title i {
            margin-right: 8px;
        }

        .explanation-content {
            color: #075985;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .challenge-hint {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #92400e;
            display: none;
        }

        .challenge-hint.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .concept-box {
            background: #e0f2fe;
            border: 1px solid #0288d1;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            font-size: 0.85rem;
            color: #01579b;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @media (max-width: 1200px) {
            .graph-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .measurement-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .waveform-display {
                grid-template-columns: 1fr;
                height: auto;
            }

            .matching-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .challenge-controls {
                justify-content: center;
            }

            .simulation-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 15px;
            }
            
            .title {
                font-size: 1.8rem;
            }
            
            .experiment-tabs {
                flex-direction: column;
            }
            
            .measurement-grid {
                grid-template-columns: 1fr;
            }

            .challenge-stats {
                flex-direction: column;
                gap: 15px;
            }

            .status-display {
                grid-template-columns: repeat(2, 1fr);
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="experiment-tabs">
            <button class="tab active" onclick="switchTab(this, 'simulation')">
                <i class="fas fa-microchip"></i> Simulation
            </button>
            <button class="tab" onclick="switchTab(this, 'characteristics')">
                <i class="fas fa-chart-line"></i> I-V Characteristics
            </button>
            <button class="tab" onclick="switchTab(this, 'amplifier')">
                <i class="fas fa-volume-up"></i> CE Amplifier
            </button>
            <button class="tab" onclick="switchTab(this, 'challenges')">
                <i class="fas fa-trophy"></i> Challenges
            </button>
        </div>

        <!-- Simulation Tab -->
        <div id="simulation" class="experiment-content active">
            <div class="main-content">
                <div class="visualization-area">
                    <h3>BJT Structure & Current Flow Visualization</h3>
                    
                    <div class="voltage-indicators">
                        <div class="voltage-label" id="vbe-indicator">VBE: 0.0V</div>
                        <div class="voltage-label" id="vce-indicator">VCE: 0.0V</div>
                        <div class="voltage-label" id="ib-indicator">IB: 0.0ŒºA</div>
                        <div class="voltage-label" id="ic-indicator">IC: 0.0mA</div>
                    </div>

                    <div class="bjt-structure">
                        <div class="bjt-layer emitter-region">
                            <span id="emitter-label">Emitter (n+)</span>
                        </div>
                        <div class="bjt-layer base-region">
                            <span id="base-label">Base (p)</span>
                        </div>
                        <div class="bjt-layer collector-region">
                            <span id="collector-label">Collector (n)</span>
                        </div>
                        
                        <div class="current-flow" id="current-flow">
                            <!-- Current arrows and carrier animations will be added here -->
                        </div>
                    </div>

                    <div class="status-display">
                        <div class="status-card" id="mode-card">
                            <div class="status-label">Operation Mode</div>
                            <div class="status-value">
                                <span class="mode-indicator mode-cutoff" id="mode-indicator">Cutoff</span>
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-label">Current Gain (Œ≤)</div>
                            <div class="status-value" id="beta-display">0</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-label">Power Dissipation</div>
                            <div class="status-value" id="power-display">0.0 mW</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-label">Transconductance</div>
                            <div class="status-value" id="gm-display">0.0 mS</div>
                        </div>
                    </div>

                    <div class="measurements-section">
                        <h3>Key Parameters</h3>
                        <div class="measurement-grid">
                            <div class="measurement-item">
                                <div class="measurement-label">VBE(on)</div>
                                <div class="measurement-value" id="vbe-on">0.70 V</div>
                            </div>
                            <div class="measurement-item">
                                <div class="measurement-label">Early Voltage</div>
                                <div class="measurement-value" id="early-voltage">100 V</div>
                            </div>
                            <div class="measurement-item">
                                <div class="measurement-label">fT (Transit Frequency)</div>
                                <div class="measurement-value" id="ft-display">500 MHz</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls-panel">
                    <h3>‚öôÔ∏è Simulation Controls</h3>
                    
                    <div class="control-group">
                        <label class="control-label">
                            ‚ö° Base-Emitter Voltage (VBE)
                            <span class="info-tooltip">‚ÑπÔ∏è
                                <span class="tooltip-text">Controls the base-emitter junction bias. Forward bias (>0.7V) turns on the BJT</span>
                            </span>
                        </label>
                        <input type="range" class="slider" id="vbe-voltage" min="0" max="1.2" step="0.01" value="0">
                        <div class="value-display" id="vbe-display">0.00 V</div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            üîå Collector-Emitter Voltage (VCE)
                            <span class="info-tooltip">‚ÑπÔ∏è
                                <span class="tooltip-text">Controls the collector-base reverse bias. Affects output characteristics and Early effect</span>
                            </span>
                        </label>
                        <input type="range" class="slider" id="vce-voltage" min="0" max="12" step="0.1" value="0">
                        <div class="value-display" id="vce-display">0.0 V</div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            üß™ Base Doping (NA)
                            <span class="info-tooltip">‚ÑπÔ∏è
                                <span class="tooltip-text">Base acceptor concentration affects current gain and base width</span>
                            </span>
                        </label>
                        <input type="range" class="slider" id="base-doping" min="16" max="19" step="0.2" value="17">
                        <div class="value-display" id="base-doping-display">10¬π‚Å∑ cm‚Åª¬≥</div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            üìè Base Width
                            <span class="info-tooltip">‚ÑπÔ∏è
                                <span class="tooltip-text">Narrower base width increases current gain but affects frequency response</span>
                            </span>
                        </label>
                        <input type="range" class="slider" id="base-width" min="0.1" max="2.0" step="0.1" value="1.0">
                        <div class="value-display" id="base-width-display">1.0 Œºm</div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            üå°Ô∏è Temperature
                            <span class="info-tooltip">‚ÑπÔ∏è
                                <span class="tooltip-text">Temperature affects VBE, current gain, and carrier mobility</span>
                            </span>
                        </label>
                        <input type="range" class="slider" id="temperature" min="200" max="450" step="10" value="300">
                        <div class="value-display" id="temp-display">300 K</div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">üîß BJT Type</label>
                        <select class="control-input" id="bjt-type">
                            <option value="npn">NPN Transistor</option>
                            <option value="pnp">PNP Transistor</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="resetSimulation()">
                        üîÑ Reset Simulation
                    </button>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>BJT Simulation:</strong> Adjust VBE and VCE to explore different operating modes. Watch the current flow animations and observe how device parameters affect performance.
            </div>
        </div>

        <!-- I-V Characteristics Tab -->
        <div id="characteristics" class="experiment-content">
            <div class="full-width-content">
                <div class="graph-container">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #1f2937;">
                        <i class="fas fa-chart-line"></i> BJT Characteristic Curves Analysis
                    </h3>
                    
                    <div class="graph-grid">
                        <div class="graph-item">
                            <div class="graph-title">
                                <i class="fas fa-chart-area"></i> Output Characteristics (IC vs VCE)
                            </div>
                            <div id="output-characteristics" class="static-graph-small"></div>
                        </div>
                        
                        <div class="graph-item">
                            <div class="graph-title">
                                <i class="fas fa-chart-line"></i> Input Characteristics (IB vs VBE)
                            </div>
                            <div id="input-characteristics" class="static-graph-small"></div>
                        </div>
                        
                        <div class="graph-item">
                            <div class="graph-title">
                                <i class="fas fa-exchange-alt"></i> Transfer Characteristics (IC vs IB)
                            </div>
                            <div id="transfer-characteristics" class="static-graph-small"></div>
                        </div>
                        
                        <div class="graph-item">
                            <div class="graph-title">
                                <i class="fas fa-thermometer-half"></i> Temperature Effects (IC vs VBE)
                            </div>
                            <div id="temperature-characteristics" class="static-graph-small"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>I-V Characteristics:</strong> Study how BJT current-voltage relationships change with different bias conditions, temperature, and device parameters. These curves are fundamental to BJT circuit design.
            </div>
        </div>

        <!-- BJT Applications Tab -->
        <div id="amplifier" class="experiment-content">
            <div class="main-content">
                <div class="visualization-area">
                    <h3 style="margin-bottom: 10px;">BJT Applications - Common Emitter Amplifier</h3>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;">
                        <!-- Left side: Circuit diagram -->
                        <div style="flex: 1; min-width: 300px; text-align: center;">
                            <h4 style="text-align: center; margin: 5px 0; color: #374151; font-size: 1rem;">
                                <i class="fas fa-microchip"></i> Common Emitter Amplifier
                            </h4>
                            
                            <div class="static-ce-amplifier" style="text-align: center;">
                                <img src="ce.png" alt="Common Emitter Amplifier Circuit" style="max-width: 90%; height: auto; border-radius: 8px; border: 1px solid #e5e7eb; margin: 0 auto; display: block;">
                                <p style="color: #6b7280; font-size: 0.8em; text-align: center; margin-top: 5px;">Standard Common Emitter Amplifier Circuit</p>
                            </div>
                            
                            <!-- Measurements included in the left side -->
                            <div class="measurements-section" style="margin-top: 10px;">
                                <h5 style="margin: 5px 0; font-size: 0.9rem;">Amplifier Parameters</h5>
                                <div class="measurement-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 0.85rem;">
                                    <div class="measurement-item" style="background: #f8fafc; padding: 5px; border-radius: 5px;">
                                        <div class="measurement-label">Current Gain</div>
                                        <div class="measurement-value" id="current-gain-display">50</div>
                                    </div>
                                    <div class="measurement-item" style="background: #f8fafc; padding: 5px; border-radius: 5px;">
                                        <div class="measurement-label">Phase Shift</div>
                                        <div class="measurement-value">180¬∞</div>
                                    </div>
                                    <div class="measurement-item" style="background: #f8fafc; padding: 5px; border-radius: 5px;">
                                        <div class="measurement-label">Input Amp</div>
                                        <div class="measurement-value" id="input-amp-display">0.1V</div>
                                    </div>
                                    <div class="measurement-item" style="background: #f8fafc; padding: 5px; border-radius: 5px;">
                                        <div class="measurement-label">Output Amp</div>
                                        <div class="measurement-value" id="output-amp-display">5.0V</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right side: Waveform simulation -->
                        <div style="flex: 1.5; min-width: 400px;">
                            <h4 style="text-align: center; margin: 5px 0; color: #374151; font-size: 1rem;">
                                <i class="fas fa-wave-square"></i> Input/Output Waveform Simulation
                            </h4>
                            <div class="waveform-simulation" style="margin-top: 5px;">
                                <div class="waveform-display" style="display: flex; gap: 10px; margin-bottom: 5px;">
                                    <div class="waveform-panel" style="flex: 1;">
                                        <div class="waveform-title" style="font-size: 0.85rem;">Input Signal (Vin)</div>
                                        <canvas class="waveform-canvas" id="input-waveform" style="height: 120px;"></canvas>
                                    </div>
                                    <div class="waveform-panel" style="flex: 1;">
                                        <div class="waveform-title" style="font-size: 0.85rem;">Output Signal (Vout)</div>
                                        <canvas class="waveform-canvas" id="output-waveform" style="height: 120px;"></canvas>
                                    </div>
                                </div>
                                <div class="simulation-controls" style="font-size: 0.85rem;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                                        <div class="control-row" style="display: flex; flex-direction: column;">
                                            <label>Amplitude: <span id="amp-value">0.1V</span></label>
                                            <input type="range" id="amplitude-slider" min="0.05" max="0.3" step="0.01" value="0.1" style="width: 100%;">
                                        </div>
                                        <div class="control-row" style="display: flex; flex-direction: column;">
                                            <label>Frequency: <span id="freq-value">1000Hz</span></label>
                                            <input type="range" id="frequency-slider" min="100" max="5000" step="100" value="1000" style="width: 100%;">
                                        </div>
                                        <div class="control-row" style="display: flex; flex-direction: column;">
                                            <label>Gain: <span id="gain-value">-50</span></label>
                                            <input type="range" id="gain-slider" min="10" max="100" step="5" value="50" style="width: 100%;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 5px; display: flex; gap: 5px; justify-content: center;">
                                        <button onclick="setupWaveformSimulation()" style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem;">üîÑ Restart</button>
                                        <button onclick="toggleWaveformAnimation()" id="playPauseBtn" style="background: #6366f1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem;">‚è∏Ô∏è Pause</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls-panel" style="padding: 15px; margin-top: 10px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">üìö CE Amplifier Theory</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="control-group" style="margin-bottom: 5px;">
                            <label class="control-label" style="font-size: 0.9rem; font-weight: 600;">üéØ Key Characteristics</label>
                            <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.8rem;">
                                <ul style="margin: 0; padding-left: 15px; color: #374151;">
                                    <li><strong>High Voltage Gain:</strong> 50-200</li>
                                    <li><strong>Phase Inversion:</strong> 180¬∞ shift</li>
                                    <li><strong>Input Impedance:</strong> 1-5 kŒ©</li>
                                    <li><strong>Output Impedance:</strong> 1-10 kŒ©</li>
                                </ul>
                            </div>
                        </div>

                        <div class="control-group" style="margin-bottom: 5px;">
                            <label class="control-label" style="font-size: 0.9rem; font-weight: 600;">‚öôÔ∏è Design Considerations</label>
                            <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.8rem;">
                                <ul style="margin: 0; padding-left: 15px; color: #374151;">
                                    <li><strong>Bias:</strong> Set for linear operation</li>
                                    <li><strong>RC:</strong> Determines voltage gain</li>
                                    <li><strong>RE:</strong> Provides stability</li>
                                    <li><strong>Coupling Caps:</strong> Block DC, pass AC</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group" style="margin-top: 5px;">
                        <label class="control-label" style="font-size: 0.9rem; font-weight: 600;">üî¨ Circuit Analysis</label>
                        <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 5px 0;">
                            <p style="margin: 0; color: #374151; font-size: 0.8rem; line-height: 1.4;">
                                The CE amplifier uses the BJT's current control property. Small base current changes produce large collector current changes, creating voltage amplification across RC. The 180¬∞ phase shift occurs because increasing base current decreases collector voltage.
                            </p>
                        </div>
                    </div>

                    <div class="control-group" style="margin-top: 5px;">
                        <label class="control-label" style="font-size: 0.9rem; font-weight: 600;">üìà Applications</label>
                        <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 0.8rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <ul style="margin: 0; padding-left: 15px; color: #374151;">
                                    <li>Audio preamplifiers</li>
                                    <li>Signal conditioning</li>
                                </ul>
                                <ul style="margin: 0; padding-left: 15px; color: #374151;">
                                    <li>Driver stages</li>
                                    <li>RF amplifiers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info" style="margin-top: 10px; padding: 10px; font-size: 0.9rem; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                <strong>BJT Applications:</strong> The Common Emitter configuration is the most widely used BJT amplifier circuit. It provides excellent voltage gain and is the building block for many electronic systems.
            </div>
        </div>

        <!-- Challenges Tab -->
        <div id="challenges" class="experiment-content">
            <div class="challenge-container">
                <h2 style="text-align: center; margin-bottom: 30px; color: #1f2937;">
                    <i class="fas fa-trophy" style="color: #f59e0b; margin-right: 10px;"></i>
                    BJT Physics Knowledge Challenges
                </h2>

                <!-- Challenge Statistics -->
                <div class="challenge-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalChallenges">5</div>
                        <div class="stat-label">Total Challenges</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completedChallenges">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="challengeScore">0</div>
                        <div class="stat-label">Score</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="challenge-progress">
                    <div class="challenge-progress-bar" id="overallProgress" style="width: 0%;"></div>
                </div>

                <!-- Reset Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="challenge-btn challenge-btn-primary" onclick="resetAllChallenges()" style="font-size: 1rem; padding: 12px 30px;">
                        <i class="fas fa-refresh"></i> Generate New Questions
                    </button>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-top: 8px;">
                        Click to reset all challenges with different questions from the BJT physics question bank
                    </p>
                </div>

                <!-- Challenge sections will be generated here -->
                <div id="challenge-content"></div>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-button primary" onclick="toggleHelp()">
        <i class="fas fa-question"></i>
    </div>
    <div class="floating-button tour" onclick="startGuidedTour()">
        <i class="fas fa-map-signs"></i>
    </div>

    <!-- Tour Elements -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-spotlight" id="tourSpotlight"></div>
        <div class="tour-spotlight-secondary" id="tourSpotlightSecondary" style="display: none;"></div>
    </div>

    <div class="tour-popup" id="tourPopup">
        <div class="tour-header">
            <div class="tour-step-number" id="tourStepNumber">1</div>
            <h3 class="tour-title" id="tourTitle">Welcome to BJT Lab</h3>
        </div>
        <div class="tour-progress">
            <div class="tour-progress-bar" id="tourProgressBar"></div>
        </div>
        <div class="tour-content" id="tourContent">
            Welcome to the BJT Physics Lab! This guided tour will walk you through all the features of this simulation.
        </div>
        <div class="tour-controls">
            <button class="tour-btn tour-btn-secondary" id="tourPrevBtn" onclick="prevTourStep()">Previous</button>
            <button class="tour-btn tour-btn-secondary" id="tourSkipBtn" onclick="skipTour()">Skip Tour</button>
            <button class="tour-btn tour-btn-primary" id="tourNextBtn" onclick="nextTourStep()">Next</button>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="floating-panel" id="helpPanel">
        <div class="floating-panel-header">
            <h3 class="panel-title">Help & Information</h3>
            <div class="floating-panel-close" onclick="toggleHelp()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="floating-panel-content">
            <h4>Quick Guide:</h4>
            <p><strong>Simulation:</strong> Adjust VBE/VCE to explore BJT operating modes and observe current flow animations.</p>
            <p><strong>I-V Characteristics:</strong> Study comprehensive BJT characteristic curves including output, input, transfer, and temperature effects.</p>
            <p><strong>CE Amplifier:</strong> Interactive waveform simulation with real-time controls. Upload your own circuit diagrams for reference!</p>
            <p><strong>Challenges:</strong> Test your knowledge with interactive exercises including matching, fill-in-blanks, and calculations.</p>
            
            <h4>Key BJT Concepts:</h4>
            <p><strong>Operating Modes:</strong> Cutoff, Active, Saturation, Reverse Active</p>
            <p><strong>Current Gain (Œ≤):</strong> IC = Œ≤ √ó IB in active mode</p>
            <p><strong>Early Effect:</strong> Output resistance in active region</p>
            <p><strong>Temperature Effects:</strong> VBE decreases ~2mV/¬∞C</p>
            
            <h4>CE Amplifier Features:</h4>
            <p><strong>üéõÔ∏è Interactive Controls:</strong> Adjust amplitude, frequency, and gain in real-time</p>
            <p><strong>üìä Live Waveforms:</strong> See input/output signals with 180¬∞ phase shift</p>
            <p><strong>üñºÔ∏è Circuit Upload:</strong> Add your own CE amplifier circuit diagrams</p>
            <p><strong>üéØ Drag & Drop:</strong> Simply drag image files to upload</p>
            
            <h4>Challenge Features:</h4>
            <p><strong>üéØ Multiple Types:</strong> True/False, Multiple Choice, Fill-in-blanks, Matching, Calculations</p>
            <p><strong>üèÜ Scoring System:</strong> Earn points for correct answers</p>
            <p><strong>üí° Detailed Explanations:</strong> Learn from mistakes with comprehensive feedback</p>
            <p><strong>üìä Progress Tracking:</strong> Monitor your learning progress</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'simulation';
        let helpPanelVisible = false;
        let tourActive = false;
        let currentTourStep = 0;
        let inputCanvas, outputCanvas, inputCtx, outputCtx;
        let animationId;
        let waveformAnimationRunning = true;

        // Waveform simulation state
        let waveformState = {
            amplitude: 0.1,
            frequency: 1000,
            gain: -50,
            time: 0
        };

        // BJT simulation state
        let bjtState = {
            vbe: 0,
            vce: 0,
            baseDoping: 17,
            baseWidth: 1.0,
            temperature: 300,
            bjtType: 'npn',
            currentMode: 'cutoff',
            ib: 0,
            ic: 0,
            ie: 0,
            beta: 100,
            isAnimating: false
        };

        // Physics constants
        const PHYSICS = {
            k: 1.38e-23,  // Boltzmann constant
            q: 1.6e-19,   // Elementary charge
            VT: function(T) { return PHYSICS.k * T / PHYSICS.q; }, // Thermal voltage
            ni: 1.45e10   // Intrinsic carrier concentration (cm^-3)
        };

        // BJT Model Parameters
        const BJT_PARAMS = {
            IS: 1e-12,      // Saturation current (A)
            BF: 150,        // Forward beta
            BR: 1,          // Reverse beta
            VA: 75,         // Early voltage (V)
            VBE_ON: 0.65,   // Base-emitter on voltage
            n: 1.0          // Ideality factor
        };

        // Challenge tracking
        let challengeAnswers = {
            quiz1: [],
            advanced: [],
            fillBlanks: [],
            matching: {},
            calculations: []
        };

        let challengeStates = {
            1: false, // Rapid Fire Quiz
            2: false, // Fill in Blanks
            3: false, // Matching
            4: false, // Advanced Concepts
            5: false  // Calculations
        };

        // Enhanced question bank with detailed explanations and hints
        const questionBank = {
            rapidFire: [
                { 
                    q: "BJTs are current-controlled devices.", 
                    a: true,
                    explanation: "BJTs are indeed current-controlled devices where the base current controls the collector current. IC = Œ≤ √ó IB in the active region.",
                    hint: "Think about the relationship between base current and collector current in a BJT."
                },
                { 
                    q: "In saturation mode, both junctions are forward biased.", 
                    a: true,
                    explanation: "In saturation, both the base-emitter and base-collector junctions are forward biased. This occurs when VBE > 0.7V and VCE < (VBE - 0.4V).",
                    hint: "Consider what happens to both junctions when the BJT is in saturation."
                },
                { 
                    q: "Higher temperature increases VBE.", 
                    a: false,
                    explanation: "VBE decreases with temperature at approximately -2mV/¬∞C due to the temperature dependence of the silicon bandgap.",
                    hint: "Think about how semiconductor bandgap changes with temperature."
                },
                { 
                    q: "The Early effect causes output resistance in BJTs.", 
                    a: true,
                    explanation: "The Early effect describes the slight increase in IC with increasing VCE in the active region, creating a finite output resistance.",
                    hint: "The Early effect is related to the base width modulation with changing VCE."
                },
                { 
                    q: "Common Emitter amplifiers provide 0¬∞ phase shift.", 
                    a: false,
                    explanation: "CE amplifiers provide 180¬∞ phase shift. When input increases, base current increases, collector current increases, and collector voltage decreases.",
                    hint: "Think about what happens to the output voltage when the input voltage increases in a CE amplifier."
                },
                { 
                    q: "Base width affects current gain in BJTs.", 
                    a: true,
                    explanation: "Narrower base width increases current gain because fewer carriers recombine in the base, allowing more to reach the collector.",
                    hint: "Consider how carrier transport through the base region affects the current gain."
                },
                { 
                    q: "NPN and PNP BJTs have the same current directions.", 
                    a: false,
                    explanation: "NPN and PNP BJTs have opposite current directions. In NPN, conventional current flows into the collector; in PNP, it flows out.",
                    hint: "Think about the doping types and how this affects current flow directions."
                },
                { 
                    q: "The transconductance gm = IC/VT.", 
                    a: true,
                    explanation: "The transconductance gm = IC/VT where VT is the thermal voltage. This relationship is fundamental for small-signal analysis.",
                    hint: "Transconductance relates small changes in input voltage to output current."
                },
                { 
                    q: "In cutoff mode, both junctions are reverse biased.", 
                    a: true,
                    explanation: "In cutoff, both base-emitter and base-collector junctions are reverse biased, resulting in very small leakage currents.",
                    hint: "Cutoff means the BJT is 'off' - what does this imply about the junction biasing?"
                },
                { 
                    q: "Beta (Œ≤) is constant for all operating conditions.", 
                    a: false,
                    explanation: "Beta varies with collector current, temperature, and can be different in different operating modes (especially saturation).",
                    hint: "Current gain depends on several factors including operating point and temperature."
                },
                { 
                    q: "The base region is typically the thinnest in a BJT.", 
                    a: true,
                    explanation: "The base region is made very thin to minimize recombination and achieve high current gain. This is crucial for BJT operation.",
                    hint: "Think about which region needs to be thin for efficient current transfer."
                },
                { 
                    q: "BJTs can operate as switches or amplifiers.", 
                    a: true,
                    explanation: "BJTs are versatile devices that can operate as switches (cutoff/saturation) or linear amplifiers (active region).",
                    hint: "Consider the different operating modes and their applications."
                },
                { 
                    q: "The collector current is independent of VCE in active mode.", 
                    a: false,
                    explanation: "Due to the Early effect, collector current slightly increases with VCE in the active region, creating finite output resistance.",
                    hint: "The Early effect describes the dependence of IC on VCE in the active region."
                },
                { 
                    q: "Higher doping in the base reduces current gain.", 
                    a: true,
                    explanation: "Higher base doping increases recombination in the base region, reducing the current gain Œ≤.",
                    hint: "More doping means more recombination centers in the base."
                },
                { 
                    q: "BJTs have infinite input impedance.", 
                    a: false,
                    explanation: "BJTs have finite input impedance due to the base current requirement. The input impedance is typically rœÄ = Œ≤/gm.",
                    hint: "BJTs require base current to operate, unlike ideal voltage-controlled devices."
                },
                { 
                    q: "The emitter is heavily doped compared to the base.", 
                    a: true,
                    explanation: "The emitter is heavily doped to ensure efficient injection of carriers into the base, improving the emitter efficiency.",
                    hint: "Heavy doping in the emitter ensures good carrier injection efficiency."
                },
                { 
                    q: "Transit frequency fT increases with collector current.", 
                    a: true,
                    explanation: "fT = gm/(2œÄ¬∑CœÄ) and since gm increases with IC, fT also increases with collector current up to a point.",
                    hint: "Transit frequency is related to transconductance, which depends on collector current."
                },
                { 
                    q: "The base-collector junction is forward biased in active mode.", 
                    a: false,
                    explanation: "In active mode, the base-emitter junction is forward biased while the base-collector junction is reverse biased.",
                    hint: "Active mode requires specific biasing conditions for the two junctions."
                },
                { 
                    q: "Common Base amplifiers have high input impedance.", 
                    a: false,
                    explanation: "Common Base amplifiers have low input impedance, typically around re = VT/IE, which is usually less than 50Œ©.",
                    hint: "The input impedance of CB amplifiers is determined by the emitter resistance."
                },
                { 
                    q: "Breakdown voltage decreases with higher doping.", 
                    a: true,
                    explanation: "Higher doping concentration leads to stronger electric fields, resulting in lower breakdown voltages in the junctions.",
                    hint: "Higher doping creates stronger electric fields at lower voltages."
                }
            ],
            
            fillInTheBlanks: [
                {
                    text: "In a BJT, the collector current IC = {blank1} √ó {blank2} in the active region, where {blank1} is the {blank3} gain.",
                    answers: { blank1: "Œ≤", blank2: "ib", blank3: "current" },
                    explanations: {
                        blank1: "Œ≤ (beta) is the current gain parameter",
                        blank2: "IB is the base current that controls the collector current",
                        blank3: "Beta represents the current amplification capability"
                    },
                    hint: "The fundamental relationship in BJT operation involves current gain"
                },
                {
                    text: "The transconductance gm = {blank1} / {blank2}, where {blank2} = kT/q is the {blank3} voltage.",
                    answers: { blank1: "ic", blank2: "vt", blank3: "thermal" },
                    explanations: {
                        blank1: "IC is the collector current (bias point)",
                        blank2: "VT is the thermal voltage at a given temperature",
                        blank3: "Thermal voltage represents the voltage equivalent of thermal energy"
                    },
                    hint: "Transconductance relates to small-signal behavior and thermal voltage"
                },
                {
                    text: "In saturation mode, both the {blank1}-emitter and {blank1}-collector junctions are {blank2} biased.",
                    answers: { blank1: "base", blank2: "forward" },
                    explanations: {
                        blank1: "The base terminal is common to both junctions",
                        blank2: "Both junctions have positive voltage across them in saturation"
                    },
                    hint: "Saturation occurs when the BJT is fully 'on'"
                },
                {
                    text: "The Early voltage VA represents the {blank1} resistance effect, where IC increases slightly with increasing {blank2}.",
                    answers: { blank1: "output", blank2: "vce" },
                    explanations: {
                        blank1: "Output resistance describes how output current varies with output voltage",
                        blank2: "VCE is the collector-emitter voltage"
                    },
                    hint: "The Early effect describes finite output resistance in BJTs"
                },
                {
                    text: "VBE decreases by approximately {blank1} mV/¬∞C with increasing temperature due to {blank2} bandgap changes.",
                    answers: { blank1: "2", blank2: "silicon" },
                    explanations: {
                        blank1: "The temperature coefficient of VBE is about -2mV/¬∞C",
                        blank2: "Silicon bandgap decreases with temperature"
                    },
                    hint: "Temperature effects in semiconductors are related to bandgap changes"
                },
                {
                    text: "In a Common Emitter amplifier, there is a {blank1}¬∞ phase shift between input and output signals.",
                    answers: { blank1: "180" },
                    explanations: {
                        blank1: "CE amplifiers invert the signal due to the amplification mechanism"
                    },
                    hint: "Consider what happens to the output when the input increases in a CE amplifier"
                },
                {
                    text: "The base region is made very {blank1} to minimize {blank2} and maximize current gain.",
                    answers: { blank1: "thin", blank2: "recombination" },
                    explanations: {
                        blank1: "Thin base reduces the distance carriers must travel",
                        blank2: "Recombination in the base reduces current gain"
                    },
                    hint: "The base width is critical for efficient BJT operation"
                },
                {
                    text: "The transit frequency fT = {blank1} / (2œÄ √ó {blank2}), where {blank2} is the input capacitance.",
                    answers: { blank1: "gm", blank2: "cœÄ" },
                    explanations: {
                        blank1: "gm is the transconductance",
                        blank2: "CœÄ is the base-emitter capacitance"
                    },
                    hint: "Transit frequency relates transconductance to input capacitance"
                },
                {
                    text: "In cutoff mode, both junctions are {blank1} biased, resulting in very {blank2} currents.",
                    answers: { blank1: "reverse", blank2: "small" },
                    explanations: {
                        blank1: "Reverse bias blocks current flow",
                        blank2: "Only leakage currents flow in cutoff"
                    },
                    hint: "Cutoff means the BJT is 'off' or non-conducting"
                },
                {
                    text: "The input impedance of a CE amplifier is approximately {blank1} = Œ≤ / {blank2}.",
                    answers: { blank1: "rœÄ", blank2: "gm" },
                    explanations: {
                        blank1: "rœÄ is the small-signal input resistance",
                        blank2: "gm is the transconductance"
                    },
                    hint: "Input impedance relates current gain to transconductance"
                }
            ],
            
            advancedConcepts: [
                {
                    q: "What happens to the Early voltage when base doping increases?",
                    options: ["It increases", "It decreases", "It stays constant", "It becomes negative"],
                    correct: "It decreases",
                    explanation: "Higher base doping reduces the Early voltage because the base width modulation effect becomes less pronounced with higher doping concentration.",
                    wrongExplanations: {
                        "It increases": "Higher base doping actually reduces the Early voltage due to reduced base width modulation.",
                        "It stays constant": "Early voltage is dependent on doping concentrations and junction characteristics.",
                        "It becomes negative": "Early voltage is always positive, representing the extrapolated voltage intercept."
                    },
                    hint: "Consider how base doping affects base width modulation under varying VCE."
                },
                {
                    q: "Which parameter most strongly affects the transit frequency fT?",
                    options: ["Base width", "Collector doping", "Emitter area", "Temperature"],
                    correct: "Base width",
                    explanation: "Base width has the strongest effect on fT because it directly affects carrier transit time. fT ‚àù 1/(base width)¬≤.",
                    wrongExplanations: {
                        "Collector doping": "While collector doping affects some parameters, base width has a much stronger effect on transit frequency.",
                        "Emitter area": "Emitter area affects current levels but not the fundamental speed limitations.",
                        "Temperature": "Temperature has some effect but base width dominates transit frequency."
                    },
                    hint: "Transit frequency is fundamentally limited by how quickly carriers can cross the base region."
                },
                {
                    q: "In which region does the BJT exhibit negative resistance?",
                    options: ["Active region", "Saturation region", "Cutoff region", "None - BJTs don't exhibit negative resistance"],
                    correct: "None - BJTs don't exhibit negative resistance",
                    explanation: "BJTs do not exhibit negative resistance in normal operation. They always have positive incremental resistance in all operating regions.",
                    wrongExplanations: {
                        "Active region": "In active region, BJTs show positive output resistance due to Early effect.",
                        "Saturation region": "Even in saturation, the resistance remains positive though very small.",
                        "Cutoff region": "In cutoff, resistance is very high but still positive."
                    },
                    hint: "Consider the I-V characteristics of BJTs in different operating regions."
                },
                {
                    q: "What causes the base width modulation (Early effect)?",
                    options: ["Temperature changes", "Collector voltage changes", "Base current changes", "Emitter area variations"],
                    correct: "Collector voltage changes",
                    explanation: "Base width modulation occurs when changing VCE alters the depletion region of the base-collector junction, effectively changing the base width.",
                    wrongExplanations: {
                        "Temperature changes": "Temperature affects other parameters but doesn't directly cause base width modulation.",
                        "Base current changes": "Base current is a result, not a cause of base width modulation.",
                        "Emitter area variations": "Emitter area affects current density but not base width modulation."
                    },
                    hint: "The Early effect is related to how the collector voltage affects the junction depletion regions."
                },
                {
                    q: "Which BJT configuration has the highest voltage gain?",
                    options: ["Common Emitter", "Common Base", "Common Collector", "All have the same gain"],
                    correct: "Common Emitter",
                    explanation: "Common Emitter configuration provides the highest voltage gain, typically 50-200, because it amplifies both current and voltage.",
                    wrongExplanations: {
                        "Common Base": "CB provides current gain close to 1 and moderate voltage gain.",
                        "Common Collector": "CC (emitter follower) has voltage gain less than 1 but high current gain.",
                        "All have the same gain": "Different configurations have distinctly different gain characteristics."
                    },
                    hint: "Consider which configuration amplifies both current and voltage simultaneously."
                },
                {
                    q: "What limits the maximum frequency operation of a BJT?",
                    options: ["Parasitic capacitances", "Base resistance", "Early effect", "Temperature"],
                    correct: "Parasitic capacitances",
                    explanation: "Parasitic capacitances (CœÄ and CŒº) limit high-frequency operation by creating phase shifts and gain reduction. Transit frequency fT = gm/(2œÄCœÄ).",
                    wrongExplanations: {
                        "Base resistance": "Base resistance affects noise and voltage drop but is not the primary frequency limitation.",
                        "Early effect": "Early effect affects output resistance but not frequency response.",
                        "Temperature": "Temperature affects parameters but parasitic capacitances are the main frequency limitation."
                    },
                    hint: "Think about what happens to AC signals at high frequencies in semiconductor devices."
                }
            ],
            
            calculations: [
                {
                    problem: "A BJT has Œ≤ = 100 and IC = 2mA. The base current IB is {blank1} ŒºA",
                    answers: { blank1: "20" },
                    tolerance: 2,
                    explanation: "Using IC = Œ≤ √ó IB, we get IB = IC/Œ≤ = 2mA/100 = 20ŒºA",
                    hint: "Use the basic BJT current relationship IC = Œ≤ √ó IB"
                },
                {
                    problem: "At room temperature (300K), the thermal voltage VT is approximately {blank1} mV",
                    answers: { blank1: "26" },
                    tolerance: 2,
                    explanation: "VT = kT/q = (1.38√ó10‚Åª¬≤¬≥ √ó 300)/(1.6√ó10‚Åª¬π‚Åπ) ‚âà 26mV",
                    hint: "Use VT = kT/q where k is Boltzmann constant and q is elementary charge"
                },
                {
                    problem: "If IC = 1mA and VT = 26mV, the transconductance gm is {blank1} mS",
                    answers: { blank1: "38.5" },
                    tolerance: 2,
                    explanation: "gm = IC/VT = 1mA/26mV = 38.5mS",
                    hint: "Use the relationship gm = IC/VT"
                },
                {
                    problem: "A BJT with Œ≤ = 150 and gm = 40mS has an input resistance rœÄ of {blank1} kŒ©",
                    answers: { blank1: "3.75" },
                    tolerance: 0.5,
                    explanation: "rœÄ = Œ≤/gm = 150/40mS = 3.75kŒ©",
                    hint: "Input resistance relates current gain to transconductance: rœÄ = Œ≤/gm"
                },
                {
                    problem: "If VBE decreases by 2mV/¬∞C and temperature increases from 25¬∞C to 75¬∞C, VBE changes by {blank1} mV",
                    answers: { blank1: "-100" },
                    tolerance: 5,
                    explanation: "ŒîT = 75¬∞C - 25¬∞C = 50¬∞C. ŒîVBE = -2mV/¬∞C √ó 50¬∞C = -100mV",
                    hint: "Use the temperature coefficient of VBE: -2mV/¬∞C"
                }
            ]
        };

        // Random question selection system
        let selectedQuestions = {
            rapidFire: [],
            fillInTheBlanks: [],
            advancedConcepts: [],
            calculations: []
        };

        function selectRandomQuestions() {
            selectedQuestions.rapidFire = getRandomItems(questionBank.rapidFire, 3);
            selectedQuestions.fillInTheBlanks = getRandomItems(questionBank.fillInTheBlanks, 3);
            selectedQuestions.advancedConcepts = getRandomItems(questionBank.advancedConcepts, 2);
            selectedQuestions.calculations = getRandomItems(questionBank.calculations, 2);
        }

        function getRandomItems(array, count) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function initializeChallengeAnswers() {
            challengeAnswers.quiz1 = new Array(selectedQuestions.rapidFire.length).fill(null);
            challengeAnswers.advanced = new Array(selectedQuestions.advancedConcepts.length).fill(null);
            challengeAnswers.fillBlanks = [];
            challengeAnswers.calculations = [];
        }

        // Matching system variables
        let selectedMatchingItems = [];
        let connectionLines = {};
        let currentConnectionId = 0;

        // Initialize simulation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing BJT simulation...');
            
            setupEventListeners();
            createCurrentAnimations();
            updateSimulation();
            
            setTimeout(() => {
                initializeGraphs();
            }, 100);
            
            // Initialize waveform simulation after a delay to ensure DOM is ready
            setTimeout(() => {
                setupWaveformSimulation();
            }, 300);
            
            // Initialize challenges
            selectRandomQuestions();
            initializeChallengeAnswers();
            generateAllChallenges();
            updateChallengeStats();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopWaveformAnimation();
        });

        function setupEventListeners() {
            // Simulation controls
            document.getElementById('vbe-voltage').addEventListener('input', function() {
                bjtState.vbe = parseFloat(this.value);
                updateSimulation();
            });

            document.getElementById('vce-voltage').addEventListener('input', function() {
                bjtState.vce = parseFloat(this.value);
                updateSimulation();
            });

            document.getElementById('base-doping').addEventListener('input', function() {
                bjtState.baseDoping = parseFloat(this.value);
                updateSimulation();
            });

            document.getElementById('base-width').addEventListener('input', function() {
                bjtState.baseWidth = parseFloat(this.value);
                updateSimulation();
            });

            document.getElementById('temperature').addEventListener('input', function() {
                bjtState.temperature = parseFloat(this.value);
                updateSimulation();
            });

            document.getElementById('bjt-type').addEventListener('change', function() {
                bjtState.bjtType = this.value;
                updateSimulation();
            });

            // Waveform simulation controls
            setTimeout(() => {
                const ampSlider = document.getElementById('amplitude-slider');
                const freqSlider = document.getElementById('frequency-slider');
                const gainSlider = document.getElementById('gain-slider');

                if (ampSlider) {
                    ampSlider.addEventListener('input', function() {
                        waveformState.amplitude = parseFloat(this.value);
                        document.getElementById('amp-value').textContent = this.value + 'V';
                        document.getElementById('input-amp-display').textContent = this.value + 'V';
                        updateAmplifierMeasurements();
                        console.log('Amplitude changed to:', waveformState.amplitude);
                    });
                }

                if (freqSlider) {
                    freqSlider.addEventListener('input', function() {
                        waveformState.frequency = parseFloat(this.value);
                        document.getElementById('freq-value').textContent = this.value + 'Hz';
                        console.log('Frequency changed to:', waveformState.frequency);
                    });
                }

                if (gainSlider) {
                    gainSlider.addEventListener('input', function() {
                        waveformState.gain = -parseFloat(this.value);
                        document.getElementById('gain-value').textContent = waveformState.gain.toString();
                        document.getElementById('current-gain-display').textContent = Math.abs(waveformState.gain);
                        updateAmplifierMeasurements();
                        console.log('Gain changed to:', waveformState.gain);
                    });
                }
                
                console.log('Waveform control listeners attached successfully');
            }, 500);
        }

        // BJT Physics Model Functions
        function calculateBJTParameters() {
            const VT = PHYSICS.VT(bjtState.temperature);
            
            // Temperature scaling for saturation current
            const tempRatio = bjtState.temperature / 300;
            const IS = 1e-14 * Math.pow(tempRatio, 4) * Math.exp(-1.12 / (2 * VT) * (1 - 1/tempRatio));
            
            // Base width and doping effects on beta
            const baseDopingFactor = Math.pow(10, bjtState.baseDoping) / 1e17;
            const baseWidthEffect = 1.0 / (bjtState.baseWidth * bjtState.baseWidth);
            let betaF = BJT_PARAMS.BF * baseWidthEffect / Math.sqrt(baseDopingFactor);
            betaF = Math.max(50, Math.min(betaF, 400));
            
            // Determine operating mode and calculate currents
            const vbc = bjtState.vbe - bjtState.vce;
            
            if (bjtState.vbe < 0.4) {
                // Cutoff mode
                bjtState.currentMode = 'cutoff';
                bjtState.ic = IS;
                bjtState.ib = bjtState.ic / (betaF * 100);
                bjtState.ie = bjtState.ic + bjtState.ib;
                bjtState.beta = betaF;
                
            } else if (bjtState.vbe >= 0.4 && bjtState.vce > Math.max(0.2, bjtState.vbe - 0.4)) {
                // Active mode
                bjtState.currentMode = 'active';
                
                const vbeNormalized = Math.max(0, bjtState.vbe - 0.6);
                bjtState.ic = IS * Math.exp(vbeNormalized / VT);
                
                // Apply Early effect
                if (bjtState.vce > 0.5) {
                    const earlyVoltage = BJT_PARAMS.VA * (1e17 / Math.pow(10, bjtState.baseDoping));
                    bjtState.ic *= (1 + bjtState.vce / earlyVoltage);
                }
                
                bjtState.ib = bjtState.ic / betaF;
                bjtState.ie = bjtState.ic + bjtState.ib;
                bjtState.beta = betaF;
                
                bjtState.ic = Math.min(bjtState.ic, 0.1);
                bjtState.ib = bjtState.ic / betaF;
                bjtState.ie = bjtState.ic + bjtState.ib;
                
            } else if (bjtState.vbe >= 0.4 && bjtState.vce <= Math.max(0.2, bjtState.vbe - 0.4)) {
                // Saturation mode
                bjtState.currentMode = 'saturation';
                
                const vbeNormalized = Math.max(0, bjtState.vbe - 0.6);
                const maxIc = IS * Math.exp(vbeNormalized / VT);
                
                bjtState.ic = maxIc * (1 - Math.exp(-bjtState.vce / 0.1));
                bjtState.ic = Math.min(bjtState.ic, 0.05);
                
                const betaSat = betaF / 5;
                bjtState.ib = bjtState.ic / betaSat + IS * Math.exp(vbc / VT) / betaF;
                bjtState.ie = bjtState.ic + bjtState.ib;
                bjtState.beta = betaSat;
                
            } else {
                // Reverse active mode
                bjtState.currentMode = 'reverse';
                bjtState.ic = IS * Math.exp(vbc / VT) / 100;
                bjtState.ib = bjtState.ic * 50;
                bjtState.ie = bjtState.ib - bjtState.ic;
                bjtState.beta = 0.02;
            }
            
            // Apply current limits
            bjtState.ic = Math.max(IS/1000, Math.min(bjtState.ic, 0.2));
            bjtState.ib = Math.max(IS/10000, Math.min(bjtState.ib, 0.02));
            bjtState.ie = Math.max(IS/1000, Math.min(bjtState.ie, 0.22));
            
            // Set minimum detectable currents
            if (bjtState.ic < 1e-12) bjtState.ic = IS/1000;
            if (bjtState.ib < 1e-13) bjtState.ib = IS/10000;
            if (bjtState.ie < 1e-12) bjtState.ie = IS/1000;
            
            // Recalculate beta from actual currents
            if (bjtState.ib > 1e-13) {
                bjtState.beta = bjtState.ic / bjtState.ib;
            } else {
                bjtState.beta = betaF;
            }
            
            // Adjust for BJT type
            if (bjtState.bjtType === 'pnp') {
                bjtState.ic *= -1;
                bjtState.ib *= -1;
                bjtState.ie *= -1;
            }
        }

        function updateSimulation() {
            calculateBJTParameters();
            updateVisualElements();
            updateStatusDisplay();
            updateControlDisplays();
            updateCurrentAnimations();
        }

        function updateVisualElements() {
            const emitterLabel = document.getElementById('emitter-label');
            const baseLabel = document.getElementById('base-label');
            const collectorLabel = document.getElementById('collector-label');

            if (bjtState.bjtType === 'npn') {
                emitterLabel.textContent = 'Emitter (n+)';
                baseLabel.textContent = 'Base (p)';
                collectorLabel.textContent = 'Collector (n)';
                
                document.querySelector('.emitter-region').style.background = 'linear-gradient(135deg, #ef4444, #dc2626, #b91c1c)';
                document.querySelector('.base-region').style.background = 'linear-gradient(135deg, #10b981, #059669, #047857)';
                document.querySelector('.collector-region').style.background = 'linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8)';
            } else {
                emitterLabel.textContent = 'Emitter (p+)';
                baseLabel.textContent = 'Base (n)';
                collectorLabel.textContent = 'Collector (p)';
                
                document.querySelector('.emitter-region').style.background = 'linear-gradient(135deg, #10b981, #059669, #047857)';
                document.querySelector('.base-region').style.background = 'linear-gradient(135deg, #ef4444, #dc2626, #b91c1c)';
                document.querySelector('.collector-region').style.background = 'linear-gradient(135deg, #10b981, #059669, #047857)';
            }

            const baseWidth = 15 * (bjtState.baseWidth / 1.0);
            document.querySelector('.base-region').style.width = baseWidth + '%';
            document.querySelector('.collector-region').style.left = (25 + baseWidth) + '%';
            document.querySelector('.collector-region').style.width = (75 - baseWidth) + '%';
        }

        function updateStatusDisplay() {
            const modeIndicator = document.getElementById('mode-indicator');
            const modeCard = document.getElementById('mode-card');
            
            modeIndicator.className = `mode-indicator mode-${bjtState.currentMode}`;
            modeIndicator.textContent = bjtState.currentMode.charAt(0).toUpperCase() + 
                                      bjtState.currentMode.slice(1);
            
            modeCard.classList.add('active');
            setTimeout(() => modeCard.classList.remove('active'), 1000);

            document.getElementById('vbe-indicator').textContent = `VBE: ${bjtState.vbe.toFixed(2)}V`;
            document.getElementById('vce-indicator').textContent = `VCE: ${bjtState.vce.toFixed(1)}V`;
            document.getElementById('ib-indicator').textContent = `IB: ${(Math.abs(bjtState.ib) * 1e6).toFixed(1)}ŒºA`;
            document.getElementById('ic-indicator').textContent = `IC: ${(Math.abs(bjtState.ic) * 1e3).toFixed(1)}mA`;

            document.getElementById('beta-display').textContent = Math.round(Math.abs(bjtState.beta));
            
            const collectorPower = Math.abs(bjtState.ic * bjtState.vce);
            const basePower = Math.abs(bjtState.ib * bjtState.vbe);
            const totalPower = collectorPower + basePower;
            document.getElementById('power-display').textContent = (totalPower * 1000).toFixed(1) + ' mW';
            
            const VT = PHYSICS.VT(bjtState.temperature);
            const gm = Math.abs(bjtState.ic) / VT * 1000;
            document.getElementById('gm-display').textContent = gm.toFixed(1) + ' mS';
        }

        function updateControlDisplays() {
            document.getElementById('vbe-display').textContent = bjtState.vbe.toFixed(2) + ' V';
            document.getElementById('vce-display').textContent = bjtState.vce.toFixed(1) + ' V';
            document.getElementById('base-doping-display').innerHTML = `10<sup>${bjtState.baseDoping.toFixed(1)}</sup> cm‚Åª¬≥`;
            document.getElementById('base-width-display').textContent = bjtState.baseWidth.toFixed(1) + ' Œºm';
            document.getElementById('temp-display').textContent = bjtState.temperature.toFixed(0) + ' K';
            
            const vbeOn = BJT_PARAMS.VBE_ON * (bjtState.temperature / 300);
            document.getElementById('vbe-on').textContent = vbeOn.toFixed(2) + ' V';
            
            const earlyVoltage = BJT_PARAMS.VA * (1e17 / Math.pow(10, bjtState.baseDoping));
            document.getElementById('early-voltage').textContent = earlyVoltage.toFixed(0) + ' V';
            
            const ft = 500 / (bjtState.baseWidth * bjtState.baseWidth);
            document.getElementById('ft-display').textContent = ft.toFixed(0) + ' MHz';
        }

        function createCurrentAnimations() {
            const currentFlow = document.getElementById('current-flow');
            currentFlow.innerHTML = '';

            for (let i = 0; i < 8; i++) {
                const electron = document.createElement('div');
                electron.className = 'carrier-animation electron';
                electron.style.left = '5%';
                electron.style.top = (25 + i * 6) + '%';
                electron.style.animationDelay = (i * 0.3) + 's';
                electron.style.animationDuration = '2.5s';
                currentFlow.appendChild(electron);
            }

            for (let i = 0; i < 4; i++) {
                const hole = document.createElement('div');
                hole.className = 'carrier-animation hole';
                hole.style.left = '28%';
                hole.style.top = (30 + i * 10) + '%';
                hole.style.animationDelay = (i * 0.4) + 's';
                hole.style.animationDuration = '2s';
                hole.style.animationName = 'carrier-flow-reverse';
                currentFlow.appendChild(hole);
            }

            const electronArrow = document.createElement('div');
            electronArrow.className = 'current-arrow electron-flow';
            electronArrow.style.left = '50%';
            electronArrow.style.top = '20%';
            currentFlow.appendChild(electronArrow);

            const holeArrow = document.createElement('div');
            holeArrow.className = 'current-arrow hole-flow';
            holeArrow.style.left = '30%';
            holeArrow.style.top = '70%';
            currentFlow.appendChild(holeArrow);
        }

        function updateCurrentAnimations() {
            const electrons = document.querySelectorAll('.carrier-animation.electron');
            const holes = document.querySelectorAll('.carrier-animation.hole');
            const electronArrows = document.querySelectorAll('.current-arrow.electron-flow');
            const holeArrows = document.querySelectorAll('.current-arrow.hole-flow');
            
            const isOn = bjtState.currentMode !== 'cutoff';
            const currentMagnitude = Math.abs(bjtState.ic) * 1000;
            
            electrons.forEach((electron, index) => {
                if (isOn && bjtState.vbe > 0.6) {
                    electron.style.opacity = Math.min(0.9, 0.3 + currentMagnitude * 0.1);
                    electron.style.animationPlayState = 'running';
                    
                    const speed = Math.max(1.5, 3 - currentMagnitude * 0.1);
                    electron.style.animationDuration = speed + 's';
                    
                    if (bjtState.bjtType === 'pnp') {
                        electron.style.animationName = 'carrier-flow-reverse';
                    } else {
                        electron.style.animationName = 'carrier-flow';
                    }
                } else {
                    electron.style.opacity = '0.2';
                    electron.style.animationPlayState = 'paused';
                }
            });

            holes.forEach((hole, index) => {
                if (isOn && bjtState.vbe > 0.6) {
                    hole.style.opacity = Math.min(0.7, 0.2 + currentMagnitude * 0.05);
                    hole.style.animationPlayState = 'running';
                    
                    const speed = Math.max(2, 4 - currentMagnitude * 0.1);
                    hole.style.animationDuration = speed + 's';
                    
                    if (bjtState.bjtType === 'pnp') {
                        hole.style.animationName = 'carrier-flow';
                        hole.style.opacity = Math.min(0.9, 0.4 + currentMagnitude * 0.08);
                    } else {
                        hole.style.animationName = 'carrier-flow-reverse';
                    }
                } else {
                    hole.style.opacity = '0.1';
                    hole.style.animationPlayState = 'paused';
                }
            });

            electronArrows.forEach(arrow => {
                if (isOn && currentMagnitude > 0.1) {
                    arrow.classList.add('active');
                    arrow.style.opacity = Math.min(1, 0.5 + currentMagnitude * 0.02);
                } else {
                    arrow.classList.remove('active');
                }
            });

            holeArrows.forEach(arrow => {
                if (isOn && currentMagnitude > 0.1) {
                    arrow.classList.add('active');
                    arrow.style.opacity = Math.min(0.8, 0.3 + currentMagnitude * 0.01);
                } else {
                    arrow.classList.remove('active');
                }
            });
        }

        // Graph Functions
        function initializeGraphs() {
            console.log('initializeGraphs called');
            setTimeout(updateAllGraphs, 50);
        }

        function updateAllGraphs() {
            console.log('updateAllGraphs called - rendering static graphs');
            try {
                plotOutputCharacteristics();
                plotInputCharacteristics();
                plotTransferCharacteristics();
                plotTemperatureCharacteristics();
                console.log('All static graphs rendered successfully');
            } catch (error) {
                console.error('Error updating graphs:', error);
            }
        }

        function plotOutputCharacteristics() {
            try {
                console.log('Plotting static output characteristics...');
                const element = document.getElementById('output-characteristics');
                if (!element) {
                    console.error('output-characteristics element not found');
                    return;
                }

                element.innerHTML = `
                    <div style="width: 100%; height: 350px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; position: relative;">
                        <h3 style="text-align: center; margin: 0 0 20px 0; color: #374151; font-family: Poppins;">Output Characteristics (IC vs VCE)</h3>
                        
                        <!-- Y-axis labels -->
                        <div style="position: absolute; left: 10px; top: 60px; height: 250px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>100mA</span>
                            <span>80mA</span>
                            <span>60mA</span>
                            <span>40mA</span>
                            <span>20mA</span>
                            <span>0mA</span>
                        </div>
                        
                        <!-- Graph area -->
                        <div style="margin-left: 50px; margin-right: 20px; margin-top: 20px;">
                            <!-- Grid -->
                            <svg width="100%" height="250" style="border: 1px solid #d1d5db;">
                                <!-- Vertical grid lines -->
                                <defs>
                                    <pattern id="grid" width="40" height="25" patternUnits="userSpaceOnUse">
                                        <path d="M 40 0 L 0 0 0 25" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid)" />
                                
                                <!-- Output characteristic curves for different IB values -->
                                <!-- IB = 40ŒºA -->
                                <path d="M 0 50 Q 20 55 40 60 Q 80 65 120 70 L 300 75" stroke="#8b5cf6" stroke-width="2" fill="none"/>
                                <!-- IB = 30ŒºA -->
                                <path d="M 0 75 Q 20 80 40 85 Q 80 90 120 95 L 300 100" stroke="#3b82f6" stroke-width="2" fill="none"/>
                                <!-- IB = 20ŒºA -->
                                <path d="M 0 100 Q 20 105 40 110 Q 80 115 120 120 L 300 125" stroke="#10b981" stroke-width="2" fill="none"/>
                                <!-- IB = 10ŒºA -->
                                <path d="M 0 150 Q 20 155 40 160 Q 80 165 120 170 L 300 175" stroke="#f59e0b" stroke-width="2" fill="none"/>
                                <!-- IB = 5ŒºA -->
                                <path d="M 0 200 Q 20 205 40 210 Q 80 215 120 220 L 300 225" stroke="#ef4444" stroke-width="2" fill="none"/>
                                <!-- IB = 0ŒºA (leakage) -->
                                <path d="M 0 245 L 300 245" stroke="#6b7280" stroke-width="1" fill="none"/>
                            </svg>
                        </div>
                        
                        <!-- X-axis labels -->
                        <div style="margin-left: 50px; margin-right: 20px; display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 5px;">
                            <span>0V</span>
                            <span>2V</span>
                            <span>4V</span>
                            <span>6V</span>
                            <span>8V</span>
                            <span>10V</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #374151;">VCE (Volts)</div>
                        
                        <!-- Legend -->
                        <div style="position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #8b5cf6; margin-right: 8px;"></div>IB = 40ŒºA</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #3b82f6; margin-right: 8px;"></div>IB = 30ŒºA</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #10b981; margin-right: 8px;"></div>IB = 20ŒºA</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #f59e0b; margin-right: 8px;"></div>IB = 10ŒºA</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #ef4444; margin-right: 8px;"></div>IB = 5ŒºA</div>
                            <div style="display: flex; align-items: center;"><div style="width: 20px; height: 2px; background: #6b7280; margin-right: 8px;"></div>IB = 0ŒºA</div>
                        </div>
                        
                        <!-- Y-axis label -->
                        <div style="position: absolute; left: 15px; top: 50%; transform: rotate(-90deg); transform-origin: center; font-size: 14px; color: #374151;">IC (Current)</div>
                    </div>
                `;
                
                console.log('Static output characteristics rendered successfully');
            } catch (error) {
                console.error('Error plotting output characteristics:', error);
            }
        }

        function plotInputCharacteristics() {
            try {
                console.log('Plotting static input characteristics...');
                const element = document.getElementById('input-characteristics');
                if (!element) {
                    console.error('input-characteristics element not found');
                    return;
                }

                element.innerHTML = `
                    <div style="width: 100%; height: 350px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; position: relative;">
                        <h3 style="text-align: center; margin: 0 0 20px 0; color: #374151; font-family: Poppins;">Input Characteristics (IB vs VBE)</h3>
                        
                        <!-- Y-axis labels -->
                        <div style="position: absolute; left: 10px; top: 60px; height: 250px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>100ŒºA</span>
                            <span>10ŒºA</span>
                            <span>1ŒºA</span>
                            <span>0.1ŒºA</span>
                            <span>0.01ŒºA</span>
                            <span>0.001ŒºA</span>
                        </div>
                        
                        <!-- Graph area -->
                        <div style="margin-left: 55px; margin-right: 20px; margin-top: 20px;">
                            <!-- Grid -->
                            <svg width="100%" height="250" style="border: 1px solid #d1d5db;">
                                <!-- Grid pattern -->
                                <defs>
                                    <pattern id="grid2" width="40" height="42" patternUnits="userSpaceOnUse">
                                        <path d="M 40 0 L 0 0 0 42" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid2)" />
                                
                                <!-- Input characteristic curves for different VCE values -->
                                <!-- VCE = 10V -->
                                <path d="M 0 245 Q 50 230 100 200 Q 150 150 200 100 Q 250 50 300 20" stroke="#3b82f6" stroke-width="2" fill="none"/>
                                <!-- VCE = 5V -->
                                <path d="M 0 245 Q 50 235 100 210 Q 150 160 200 110 Q 250 60 300 30" stroke="#10b981" stroke-width="2" fill="none"/>
                                <!-- VCE = 3V -->
                                <path d="M 0 245 Q 50 240 100 220 Q 150 170 200 120 Q 250 70 300 40" stroke="#f59e0b" stroke-width="2" fill="none"/>
                                <!-- VCE = 1V -->
                                <path d="M 0 245 Q 50 245 100 230 Q 150 180 200 130 Q 250 80 300 50" stroke="#ef4444" stroke-width="2" fill="none"/>
                            </svg>
                        </div>
                        
                        <!-- X-axis labels -->
                        <div style="margin-left: 55px; margin-right: 20px; display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 5px;">
                            <span>0.3V</span>
                            <span>0.45V</span>
                            <span>0.6V</span>
                            <span>0.75V</span>
                            <span>0.9V</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #374151;">VBE (Volts)</div>
                        
                        <!-- Legend -->
                        <div style="position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #3b82f6; margin-right: 8px;"></div>VCE = 10V</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #10b981; margin-right: 8px;"></div>VCE = 5V</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #f59e0b; margin-right: 8px;"></div>VCE = 3V</div>
                            <div style="display: flex; align-items: center;"><div style="width: 20px; height: 2px; background: #ef4444; margin-right: 8px;"></div>VCE = 1V</div>
                        </div>
                        
                        <!-- Y-axis label -->
                        <div style="position: absolute; left: 15px; top: 50%; transform: rotate(-90deg); transform-origin: center; font-size: 14px; color: #374151;">IB (Log Scale)</div>
                        
                        <!-- Note about exponential nature -->
                        <div style="position: absolute; bottom: 10px; left: 55px; font-size: 11px; color: #6b7280; font-style: italic;">
                            Note: Exponential increase in base current with VBE
                        </div>
                    </div>
                `;
                
                console.log('Static input characteristics rendered successfully');
            } catch (error) {
                console.error('Error plotting input characteristics:', error);
            }
        }

        function plotTransferCharacteristics() {
            try {
                console.log('Plotting static transfer characteristics...');
                const element = document.getElementById('transfer-characteristics');
                if (!element) {
                    console.error('transfer-characteristics element not found');
                    return;
                }

                element.innerHTML = `
                    <div style="width: 100%; height: 350px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; position: relative;">
                        <h3 style="text-align: center; margin: 0 0 20px 0; color: #374151; font-family: Poppins;">Transfer Characteristics (IC vs IB)</h3>
                        
                        <!-- Y-axis labels -->
                        <div style="position: absolute; left: 10px; top: 60px; height: 250px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>12mA</span>
                            <span>10mA</span>
                            <span>8mA</span>
                            <span>6mA</span>
                            <span>4mA</span>
                            <span>2mA</span>
                            <span>0mA</span>
                        </div>
                        
                        <!-- Graph area -->
                        <div style="margin-left: 50px; margin-right: 20px; margin-top: 20px;">
                            <!-- Grid -->
                            <svg width="100%" height="250" style="border: 1px solid #d1d5db;">
                                <!-- Grid pattern -->
                                <defs>
                                    <pattern id="grid3" width="40" height="21" patternUnits="userSpaceOnUse">
                                        <path d="M 40 0 L 0 0 0 21" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid3)" />
                                
                                <!-- Transfer characteristic curves showing linear relationship -->
                                <!-- VCE = 10V (highest gain due to Early effect) -->
                                <path d="M 0 250 L 50 200 L 100 150 L 150 100 L 200 50 L 250 25 L 300 15" stroke="#3b82f6" stroke-width="3" fill="none"/>
                                
                                <!-- VCE = 5V (medium gain) -->
                                <path d="M 0 250 L 50 205 L 100 160 L 150 115 L 200 70 L 250 35 L 300 25" stroke="#10b981" stroke-width="3" fill="none"/>
                                
                                <!-- VCE = 1V (lower gain, saturation effects) -->
                                <path d="M 0 250 L 50 210 L 100 170 L 150 130 L 200 90 L 250 60 L 300 45" stroke="#ef4444" stroke-width="3" fill="none"/>
                                
                                <!-- Beta lines (dashed guidelines) -->
                                <path d="M 0 250 L 300 0" stroke="#9ca3af" stroke-width="1" stroke-dasharray="5,5" fill="none" opacity="0.5"/>
                                <text x="280" y="15" font-size="10" fill="#6b7280">Œ≤ = 150</text>
                            </svg>
                        </div>
                        
                        <!-- X-axis labels -->
                        <div style="margin-left: 50px; margin-right: 20px; display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 5px;">
                            <span>0ŒºA</span>
                            <span>20ŒºA</span>
                            <span>40ŒºA</span>
                            <span>60ŒºA</span>
                            <span>80ŒºA</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #374151;">IB (Base Current)</div>
                        
                        <!-- Legend -->
                        <div style="position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 3px; background: #3b82f6; margin-right: 8px;"></div>VCE = 10V</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 3px; background: #10b981; margin-right: 8px;"></div>VCE = 5V</div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;"><div style="width: 20px; height: 3px; background: #ef4444; margin-right: 8px;"></div>VCE = 1V</div>
                            <div style="font-size: 11px; color: #6b7280;">Early Effect visible</div>
                        </div>
                        
                        <!-- Y-axis label -->
                        <div style="position: absolute; left: 15px; top: 50%; transform: rotate(-90deg); transform-origin: center; font-size: 14px; color: #374151;">IC (Collector Current)</div>
                        
                        <!-- Beta annotation -->
                        <div style="position: absolute; bottom: 10px; left: 50px; font-size: 11px; color: #6b7280; font-style: italic;">
                            Note: IC = Œ≤ √ó IB (Early effect increases slope at higher VCE)
                        </div>
                    </div>
                `;
                
                console.log('Static transfer characteristics rendered successfully');
            } catch (error) {
                console.error('Error plotting transfer characteristics:', error);
            }
        }

        function plotTemperatureCharacteristics() {
            try {
                console.log('Plotting static temperature characteristics...');
                const element = document.getElementById('temperature-characteristics');
                if (!element) {
                    console.error('temperature-characteristics element not found');
                    return;
                }

                element.innerHTML = `
                    <div style="width: 100%; height: 350px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; position: relative;">
                        <h3 style="text-align: center; margin: 0 0 20px 0; color: #374151; font-family: Poppins;">Temperature Effects on IC vs VBE</h3>
                        
                        <!-- Y-axis labels (Log scale) -->
                        <div style="position: absolute; left: 10px; top: 60px; height: 250px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: #6b7280;">
                            <span>100mA</span>
                            <span>10mA</span>
                            <span>1mA</span>
                            <span>0.1mA</span>
                            <span>0.01mA</span>
                            <span>1ŒºA</span>
                        </div>
                        
                        <!-- Graph area -->
                        <div style="margin-left: 55px; margin-right: 20px; margin-top: 20px;">
                            <!-- Grid -->
                            <svg width="100%" height="250" style="border: 1px solid #d1d5db;">
                                <!-- Grid pattern -->
                                <defs>
                                    <pattern id="grid4" width="40" height="42" patternUnits="userSpaceOnUse">
                                        <path d="M 40 0 L 0 0 0 42" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid4)" />
                                
                                <!-- Temperature characteristic curves (shifted with temperature) -->
                                <!-- T = 400K (highest temperature - leftward shift) -->
                                <path d="M 0 245 Q 30 230 60 150 Q 90 70 120 30 Q 150 15 180 10 L 300 5" stroke="#ef4444" stroke-width="2" fill="none"/>
                                
                                <!-- T = 350K (medium-high temperature) -->
                                <path d="M 0 245 Q 40 235 70 160 Q 100 80 130 40 Q 160 20 190 15 L 300 8" stroke="#f59e0b" stroke-width="2" fill="none"/>
                                
                                <!-- T = 300K (room temperature - reference) -->
                                <path d="M 0 245 Q 50 240 80 170 Q 110 90 140 50 Q 170 25 200 20 L 300 12" stroke="#10b981" stroke-width="2" fill="none"/>
                                
                                <!-- T = 250K (lowest temperature - rightward shift) -->
                                <path d="M 0 245 Q 60 245 90 180 Q 120 100 150 60 Q 180 30 210 25 L 300 16" stroke="#3b82f6" stroke-width="2" fill="none"/>
                                
                                <!-- Reference lines -->
                                <line x1="100" y1="0" x2="100" y2="250" stroke="#9ca3af" stroke-width="1" stroke-dasharray="3,3" opacity="0.5"/>
                                <text x="105" y="15" font-size="10" fill="#6b7280">VBE ‚âà 0.6V</text>
                            </svg>
                        </div>
                        
                        <!-- X-axis labels -->
                        <div style="margin-left: 55px; margin-right: 20px; display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 5px;">
                            <span>0.3V</span>
                            <span>0.45V</span>
                            <span>0.6V</span>
                            <span>0.75V</span>
                            <span>0.9V</span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #374151;">VBE (Volts)</div>
                        
                        <!-- Legend -->
                        <div style="position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #ef4444; margin-right: 8px;"></div>T = 400K</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #f59e0b; margin-right: 8px;"></div>T = 350K</div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;"><div style="width: 20px; height: 2px; background: #10b981; margin-right: 8px;"></div>T = 300K</div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;"><div style="width: 20px; height: 2px; background: #3b82f6; margin-right: 8px;"></div>T = 250K</div>
                            <div style="font-size: 11px; color: #6b7280;">Higher T ‚Üí Lower VBE</div>
                        </div>
                        
                        <!-- Y-axis label -->
                        <div style="position: absolute; left: 15px; top: 50%; transform: rotate(-90deg); transform-origin: center; font-size: 14px; color: #374151;">IC (Log Scale)</div>
                        
                        <!-- Temperature coefficient note -->
                        <div style="position: absolute; bottom: 10px; left: 55px; font-size: 11px; color: #6b7280; font-style: italic;">
                            Note: VBE decreases ~2mV/¬∞C, IS increases exponentially with temperature
                        </div>
                    </div>
                `;
                
                console.log('Static temperature characteristics rendered successfully');
            } catch (error) {
                console.error('Error plotting temperature characteristics:', error);
            }
        }

        function resetSimulation() {
            bjtState = {
                vbe: 0,
                vce: 0,
                baseDoping: 17,
                baseWidth: 1.0,
                temperature: 300,
                bjtType: 'npn',
                currentMode: 'cutoff',
                ib: 0,
                ic: 0,
                ie: 0,
                beta: 100,
                isAnimating: false
            };
            
            document.getElementById('vbe-voltage').value = 0;
            document.getElementById('vce-voltage').value = 0;
            document.getElementById('base-doping').value = 17;
            document.getElementById('base-width').value = 1.0;
            document.getElementById('temperature').value = 300;
            document.getElementById('bjt-type').value = 'npn';
            
            updateSimulation();
        }

        function switchTab(tabButton, tabName) {
            console.log('Switching to tab:', tabName);
            
            // Stop waveform animation when leaving amplifier tab
            if (currentTab === 'amplifier' && tabName !== 'amplifier') {
                stopWaveformAnimation();
            }
            
            document.querySelectorAll('.experiment-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            if (tabButton) tabButton.classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'simulation') {
                updateSimulation();
            } else if (tabName === 'characteristics') {
                setTimeout(() => {
                    updateAllGraphs();
                }, 100);
            } else if (tabName === 'amplifier') {
                setTimeout(() => {
                    console.log('Setting up amplifier tab...');
                    setupWaveformSimulation();
                }, 200);
            } else if (tabName === 'challenges') {
                updateChallengeStats();
            }
        }

        // Waveform Simulation Functions
        function setupWaveformSimulation() {
            console.log('Setting up waveform simulation...');
            
            // Stop any existing animation
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            inputCanvas = document.getElementById('input-waveform');
            outputCanvas = document.getElementById('output-waveform');
            
            console.log('Canvas elements found:', {
                input: !!inputCanvas,
                output: !!outputCanvas
            });
            
            if (inputCanvas && inputCanvas.getContext && outputCanvas && outputCanvas.getContext) {
                inputCtx = inputCanvas.getContext('2d');
                outputCtx = outputCanvas.getContext('2d');
                
                console.log('Canvas contexts obtained');
                
                // Set canvas sizes with proper dimensions
                [inputCanvas, outputCanvas].forEach((canvas, index) => {
                    // Force a specific size if getBoundingClientRect returns 0
                    let rect = canvas.getBoundingClientRect();
                    if (rect.width === 0 || rect.height === 0) {
                        // Fallback dimensions
                        rect = { width: 400, height: 140 };
                        canvas.style.width = '400px';
                        canvas.style.height = '140px';
                    }
                    
                    const pixelRatio = window.devicePixelRatio || 1;
                    canvas.width = rect.width * pixelRatio;
                    canvas.height = rect.height * pixelRatio;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.scale(pixelRatio, pixelRatio);
                    
                    console.log(`Canvas ${index} setup:`, {
                        width: canvas.width,
                        height: canvas.height,
                        styleWidth: canvas.style.width,
                        styleHeight: canvas.style.height
                    });
                });
                
                waveformAnimationRunning = true;
                startWaveformAnimation();
                updateAmplifierMeasurements();
            } else {
                console.error('Canvas elements or contexts not available');
                // Retry after a short delay
                setTimeout(() => {
                    console.log('Retrying waveform setup...');
                    setupWaveformSimulation();
                }, 500);
            }
        }

        function startWaveformAnimation() {
            console.log('Starting waveform animation...');
            
            // Stop any existing animation
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            function animate() {
                try {
                    if (inputCanvas && outputCanvas && inputCtx && outputCtx && waveformAnimationRunning) {
                        drawWaveforms();
                        waveformState.time += 0.05;
                        animationId = requestAnimationFrame(animate);
                    } else {
                        console.warn('Canvas elements lost or animation paused');
                    }
                } catch (error) {
                    console.error('Error in waveform animation:', error);
                    setTimeout(() => {
                        console.log('Attempting to restart waveform animation...');
                        setupWaveformSimulation();
                    }, 1000);
                }
            }
            
            // Start the animation
            if (waveformAnimationRunning) {
                animationId = requestAnimationFrame(animate);
                console.log('Waveform animation started with ID:', animationId);
            }
        }

        function drawWaveforms() {
            if (!inputCtx || !outputCtx || !inputCanvas || !outputCanvas) {
                console.warn('Canvas contexts not available for drawing');
                return;
            }
            
            const canvasWidth = inputCanvas.width / (window.devicePixelRatio || 1);
            const canvasHeight = inputCanvas.height / (window.devicePixelRatio || 1);
            
            // Clear canvases
            inputCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            outputCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Draw grid for both canvases
            [inputCtx, outputCtx].forEach((ctx, index) => {
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 0.5;
                
                // Horizontal grid lines
                for (let i = 0; i <= 4; i++) {
                    const y = (i / 4) * canvasHeight;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvasWidth, y);
                    ctx.stroke();
                }
                
                // Vertical grid lines
                for (let i = 0; i <= 8; i++) {
                    const x = (i / 8) * canvasWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvasHeight);
                    ctx.stroke();
                }
                
                // Center line (ground reference)
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, canvasHeight / 2);
                ctx.lineTo(canvasWidth, canvasHeight / 2);
                ctx.stroke();
            });
            
            // Calculate CE amplifier parameters based on current BJT state
            const vbeQuiescent = 0.7; // Q-point VBE
            const inputSignal = waveformState.amplitude * Math.sin(waveformState.time * waveformState.frequency / 1000);
            const instantVbe = vbeQuiescent + inputSignal;
            
            // Calculate realistic gain based on BJT parameters
            let icForGain = Math.abs(bjtState.ic);
            if (icForGain < 1e-6) {
                icForGain = 1e-3; // 1mA default
            }
            
            const gm = icForGain / PHYSICS.VT(bjtState.temperature);
            const rc = 2000; // Collector resistor (2kŒ© typical)
            let realisticGain = Math.min(gm * rc, 200);
            
            if (isNaN(realisticGain) || realisticGain < 1) {
                realisticGain = 50;
            }
            
            const userGainFactor = Math.abs(waveformState.gain) / 50;
            const totalGain = realisticGain * userGainFactor;
            
            // Draw input waveform (green sine wave)
            inputCtx.strokeStyle = '#10b981';
            inputCtx.lineWidth = 3;
            inputCtx.beginPath();
            
            const inputVoltageScale = Math.max(0.1, waveformState.amplitude * 1.5);
            
            for (let x = 0; x < canvasWidth; x++) {
                const t = (x / canvasWidth) * 4 * Math.PI + waveformState.time * waveformState.frequency / 1000;
                const amplitude = waveformState.amplitude;
                const y = canvasHeight / 2 - (amplitude / inputVoltageScale) * (canvasHeight / 3) * Math.sin(t);
                
                if (x === 0) {
                    inputCtx.moveTo(x, y);
                } else {
                    inputCtx.lineTo(x, y);
                }
            }
            inputCtx.stroke();
            
            // Draw output waveform (red inverted and amplified)
            outputCtx.strokeStyle = '#ef4444';
            outputCtx.lineWidth = 3;
            outputCtx.beginPath();
            
            const expectedOutputAmp = waveformState.amplitude * totalGain / 100;
            const clampedOutputAmp = Math.min(expectedOutputAmp, 0.25);
            
            let outputVoltageScale;
            if (clampedOutputAmp > 0.15) {
                outputVoltageScale = 0.3;
            } else if (clampedOutputAmp > 0.05) {
                outputVoltageScale = 0.2;
            } else {
                outputVoltageScale = 0.1;
            }
            
            for (let x = 0; x < canvasWidth; x++) {
                const t = (x / canvasWidth) * 4 * Math.PI + waveformState.time * waveformState.frequency / 1000;
                const inputAmp = waveformState.amplitude;
                
                let outputAmp = inputAmp * totalGain / 100;
                
                if (outputAmp < 0.01) {
                    outputAmp = inputAmp * 2;
                }
                
                const maxOutput = 0.25;
                outputAmp = Math.min(outputAmp, maxOutput);
                
                if (Math.abs(inputAmp) > 0.2) {
                    const distortion = 0.1 * Math.sin(3 * t);
                    outputAmp *= (1 + 0.05 * distortion);
                }
                
                // Phase inversion for CE amplifier (180¬∞ phase shift)
                const y = canvasHeight / 2 + (outputAmp / outputVoltageScale) * (canvasHeight / 3) * Math.sin(t);
                
                if (x === 0) {
                    outputCtx.moveTo(x, y);
                } else {
                    outputCtx.lineTo(x, y);
                }
            }
            outputCtx.stroke();
            
            // Add voltage scale labels
            [inputCtx, outputCtx].forEach((ctx, index) => {
                ctx.fillStyle = '#e5e7eb';
                ctx.font = '10px Poppins, sans-serif';
                ctx.textAlign = 'left';
                
                let maxVoltage;
                
                if (index === 0) {
                    maxVoltage = Math.max(0.1, waveformState.amplitude * 1.5);
                } else {
                    const expectedOutputAmp = waveformState.amplitude * totalGain / 100;
                    const clampedOutputAmp = Math.min(expectedOutputAmp, 0.25);
                    
                    if (clampedOutputAmp > 0.15) {
                        maxVoltage = 0.3;
                    } else if (clampedOutputAmp > 0.05) {
                        maxVoltage = 0.2;
                    } else {
                        maxVoltage = 0.1;
                    }
                }
                
                for (let i = 0; i <= 4; i++) {
                    const voltage = maxVoltage - (i / 2) * maxVoltage;
                    const y = (i / 4) * canvasHeight;
                    
                    if (i % 2 === 0) {
                        const precision = maxVoltage >= 0.2 ? 1 : 2;
                        ctx.fillText(voltage.toFixed(precision) + 'V', 2, y + 12);
                    }
                }
                
                if (index === 0) {
                    ctx.fillStyle = '#10b981';
                    ctx.font = '12px Poppins, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(`${waveformState.frequency}Hz`, canvasWidth - 5, 20);
                    
                    ctx.fillStyle = '#34d399';
                    ctx.font = '10px Poppins, sans-serif';
                    ctx.fillText(`Scale: ¬±${maxVoltage.toFixed(2)}V`, canvasWidth - 5, 35);
                } else {
                    ctx.fillStyle = '#ef4444';
                    ctx.font = '12px Poppins, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(`Gain: ${totalGain.toFixed(0)}`, canvasWidth - 5, 20);
                    
                    ctx.fillStyle = '#fbbf24';
                    ctx.font = '10px Poppins, sans-serif';
                    ctx.fillText(`Scale: ¬±${maxVoltage.toFixed(2)}V`, canvasWidth - 5, 35);
                }
            });
        }

        function stopWaveformAnimation() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                console.log('Waveform animation stopped');
            }
            waveformAnimationRunning = false;
        }

        function toggleWaveformAnimation() {
            const btn = document.getElementById('playPauseBtn');
            if (waveformAnimationRunning) {
                stopWaveformAnimation();
                btn.textContent = '‚ñ∂Ô∏è Play';
                btn.style.background = '#10b981';
            } else {
                waveformAnimationRunning = true;
                startWaveformAnimation();
                btn.textContent = '‚è∏Ô∏è Pause';
                btn.style.background = '#6366f1';
            }
        }

        function updateAmplifierMeasurements() {
            const outputAmp = waveformState.amplitude * Math.abs(waveformState.gain);
            document.getElementById('output-amp-display').textContent = (outputAmp / 100).toFixed(1) + 'V';
        }

        // Challenge System Functions
        function generateAllChallenges() {
            const container = document.getElementById('challenge-content');
            container.innerHTML = ''; // Clear existing content
            
            generateRapidFireQuiz();
            generateFillInTheBlanks();
            generateMatchingChallenge();
            generateAdvancedConcepts();
            generateCalculationChallenge();
        }

        function generateRapidFireQuiz() {
            const container = document.getElementById('challenge-content');
            
            let questionsHTML = '';
            selectedQuestions.rapidFire.forEach((question, index) => {
                questionsHTML += `
                    <div class="quiz-question">
                        <h4>${index + 1}. ${question.q}</h4>
                        <div class="quiz-options">
                            <div class="quiz-option" onclick="selectQuizAnswer(1, ${index + 1}, true, this)">True</div>
                            <div class="quiz-option" onclick="selectQuizAnswer(1, ${index + 1}, false, this)">False</div>
                        </div>
                    </div>
                `;
            });

            const challengeHTML = `
                <div class="challenge-section" id="challenge1">
                    <div class="challenge-header">
                        <div class="challenge-icon">üß†</div>
                        <div>
                            <h3 class="challenge-title">Rapid Fire Quiz</h3>
                            <p class="challenge-description">Test your understanding of BJT fundamentals with these quick questions!</p>
                        </div>
                    </div>

                    ${questionsHTML}

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkQuizAnswers(1)">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(1)">Reset</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showQuizHints(1)">Show Hints</button>
                    </div>

                    <div class="challenge-feedback" id="challenge1-feedback"></div>
                    <div class="challenge-hint" id="challenge1-hint"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', challengeHTML);
        }

        function generateFillInTheBlanks() {
            const container = document.getElementById('challenge-content');
            
            let questionsHTML = '';
            let blankCounter = 1;
            challengeAnswers.fillBlanks = [];
            
            selectedQuestions.fillInTheBlanks.forEach((question, qIndex) => {
                let processedText = question.text;
                const blanksInQuestion = [];
                
                Object.keys(question.answers).forEach(blankKey => {
                    const inputId = `blank${blankCounter}`;
                    const regex = new RegExp(`{${blankKey}}`, 'g');
                    processedText = processedText.replace(regex, 
                        `<input type="text" class="fill-blank-input" id="${inputId}" placeholder="?">`
                    );
                    
                    blanksInQuestion.push({
                        id: inputId,
                        correctAnswer: question.answers[blankKey]
                    });
                    blankCounter++;
                });
                
                challengeAnswers.fillBlanks.push(blanksInQuestion);
                
                questionsHTML += `
                    <div class="fill-blank-container">
                        <div class="fill-blank-text"><strong>Question ${qIndex + 1}:</strong> ${processedText}</div>
                    </div>
                `;
            });

            const challengeHTML = `
                <div class="challenge-section" id="challenge2">
                    <div class="challenge-header">
                        <div class="challenge-icon">üìù</div>
                        <div>
                            <h3 class="challenge-title">Fill in the Blanks</h3>
                            <p class="challenge-description">Complete these sentences about BJT physics!</p>
                        </div>
                    </div>

                    ${questionsHTML}

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkFillBlanks()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(2)">Reset</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showFillBlanksHint()">Hint</button>
                    </div>

                    <div class="challenge-feedback" id="challenge2-feedback"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', challengeHTML);
        }

        function generateMatchingChallenge() {
            const container = document.getElementById('challenge-content');

            const challengeHTML = `
                <div class="challenge-section" id="challenge3">
                    <div class="challenge-header">
                        <div class="challenge-icon">üîó</div>
                        <div>
                            <h3 class="challenge-title">Match the Following</h3>
                            <p class="challenge-description">Match the BJT terms with their correct definitions!</p>
                        </div>
                    </div>

                    <div class="matching-container">
                        <div class="matching-column">
                            <h4 style="text-align: center; margin-bottom: 15px; color: #1f2937;">Terms</h4>
                            <div class="matching-item" data-id="cutoff" onclick="selectMatchingItem(this)">
                                Cutoff Mode
                            </div>
                            <div class="matching-item" data-id="saturation" onclick="selectMatchingItem(this)">
                                Saturation Mode
                            </div>
                            <div class="matching-item" data-id="early" onclick="selectMatchingItem(this)">
                                Early Effect
                            </div>
                            <div class="matching-item" data-id="beta" onclick="selectMatchingItem(this)">
                                Current Gain (Œ≤)
                            </div>
                        </div>

                        <div class="matching-connections" id="matchingConnections">
                            <!-- Connection lines will be drawn here -->
                        </div>

                        <div class="matching-column">
                            <h4 style="text-align: center; margin-bottom: 15px; color: #1f2937;">Definitions</h4>
                            <div class="matching-item" data-id="def-cutoff" onclick="selectMatchingItem(this)">
                                Both junctions reverse biased
                            </div>
                            <div class="matching-item" data-id="def-saturation" onclick="selectMatchingItem(this)">
                                Both junctions forward biased
                            </div>
                            <div class="matching-item" data-id="def-early" onclick="selectMatchingItem(this)">
                                Output resistance effect in BJTs
                            </div>
                            <div class="matching-item" data-id="def-beta" onclick="selectMatchingItem(this)">
                                Ratio of collector to base current
                            </div>
                        </div>
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkMatching()">Check Matches</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(3)">Reset</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showMatchingHints()">Show Hints</button>
                    </div>

                    <div class="challenge-feedback" id="challenge3-feedback"></div>
                    <div class="challenge-hint" id="challenge3-hint"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', challengeHTML);
        }

        function generateAdvancedConcepts() {
            const container = document.getElementById('challenge-content');
            
            let questionsHTML = '';
            selectedQuestions.advancedConcepts.forEach((question, index) => {
                const optionsHtml = question.options.map(option => 
                    `<div class="quiz-option" onclick="selectAdvancedAnswer(${index + 1}, '${option}', this)">${option}</div>`
                ).join('');
                
                questionsHTML += `
                    <div class="quiz-question">
                        <h4>${index + 1}. ${question.q}</h4>
                        <div class="quiz-options">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            });

            const challengeHTML = `
                <div class="challenge-section" id="challenge4">
                    <div class="challenge-header">
                        <div class="challenge-icon">üéØ</div>
                        <div>
                            <h3 class="challenge-title">Advanced Concepts</h3>
                            <p class="challenge-description">Test your deeper understanding of BJT physics!</p>
                        </div>
                    </div>

                    ${questionsHTML}

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkAdvancedAnswers()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(4)">Reset</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showAdvancedHints()">Show Hints</button>
                    </div>

                    <div class="challenge-feedback" id="challenge4-feedback"></div>
                    <div class="challenge-hint" id="challenge4-hint"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', challengeHTML);
        }

        function generateCalculationChallenge() {
            const container = document.getElementById('challenge-content');
            
            let questionsHTML = '';
            let blankCounter = 1;
            challengeAnswers.calculations = [];
            
            selectedQuestions.calculations.forEach((question, qIndex) => {
                let processedText = question.problem;
                const blanksInQuestion = [];
                
                Object.keys(question.answers).forEach(blankKey => {
                    const inputId = `calc${blankCounter}`;
                    const regex = new RegExp(`{${blankKey}}`, 'g');
                    processedText = processedText.replace(regex, 
                        `<input type="text" class="fill-blank-input" id="${inputId}" placeholder="?">`
                    );
                    
                    blanksInQuestion.push({
                        id: inputId,
                        correctAnswer: question.answers[blankKey],
                        tolerance: question.tolerance || 0
                    });
                    blankCounter++;
                });
                
                challengeAnswers.calculations.push(blanksInQuestion);
                
                questionsHTML += `
                    <div class="fill-blank-container">
                        <div class="fill-blank-text">
                            <strong>Problem ${qIndex + 1}:</strong> ${processedText}
                        </div>
                    </div>
                `;
            });

            const challengeHTML = `
                <div class="challenge-section" id="challenge5">
                    <div class="challenge-header">
                        <div class="challenge-icon">üßÆ</div>
                        <div>
                            <h3 class="challenge-title">Calculation Challenge</h3>
                            <p class="challenge-description">Apply BJT physics equations to solve these numerical problems!</p>
                        </div>
                    </div>

                    ${questionsHTML}

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkCalculations()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(5)">Reset</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showCalculationHint()">Show Formula</button>
                    </div>

                    <div class="challenge-feedback" id="challenge5-feedback"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', challengeHTML);
        }

        // Quiz Answer Functions
        function selectQuizAnswer(challengeNum, questionNum, answer, element) {
            const parentQuestion = element.closest('.quiz-question');
            parentQuestion.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            
            if (challengeNum === 1) {
                challengeAnswers.quiz1[questionNum - 1] = answer;
            }
        }

        function selectAdvancedAnswer(questionNum, answer, element) {
            const parentQuestion = element.closest('.quiz-question');
            parentQuestion.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            challengeAnswers.advanced[questionNum - 1] = answer;
        }

        // Matching Functions
        function selectMatchingItem(element) {
            if (element.classList.contains('matched')) return;
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedMatchingItems = selectedMatchingItems.filter(item => item !== element);
                return;
            }
            
            element.classList.add('selected');
            selectedMatchingItems.push(element);
            
            if (selectedMatchingItems.length === 2) {
                const [item1, item2] = selectedMatchingItems;
                
                const isLeftColumn1 = item1.closest('.matching-column:first-child');
                const isLeftColumn2 = item2.closest('.matching-column:first-child');
                
                if (isLeftColumn1 !== isLeftColumn2) {
                    createMatchingPair(item1, item2);
                }
                
                item1.classList.remove('selected');
                item2.classList.remove('selected');
                selectedMatchingItems = [];
            }
        }
        
        function createMatchingPair(item1, item2) {
            const connectionId = `conn-${currentConnectionId++}`;
            
            item1.classList.add('paired', 'matched');
            item2.classList.add('paired', 'matched');
            
            connectionLines[connectionId] = { item1, item2 };
            drawConnectionLine(item1, item2, connectionId);
            
            item1.dataset.connectionId = connectionId;
            item2.dataset.connectionId = connectionId;
            
            item1.addEventListener('click', removePairHandler);
            item2.addEventListener('click', removePairHandler);
            
            // Store matching in challengeAnswers
            const leftItem = item1.closest('.matching-column:first-child') ? item1 : item2;
            const rightItem = item1.closest('.matching-column:first-child') ? item2 : item1;
            
            challengeAnswers.matching[leftItem.dataset.id] = rightItem.dataset.id;
        }
        
        function drawConnectionLine(item1, item2, connectionId) {
            const connectionsContainer = document.getElementById('matchingConnections');
            const rect1 = item1.getBoundingClientRect();
            const rect2 = item2.getBoundingClientRect();
            const containerRect = connectionsContainer.getBoundingClientRect();
            
            const x1 = rect1.right - containerRect.left;
            const y1 = rect1.top + rect1.height/2 - containerRect.top;
            const x2 = rect2.left - containerRect.left;
            const y2 = rect2.top + rect2.height/2 - containerRect.top;
            
            const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            const line = document.createElement('div');
            line.className = 'connection-line';
            line.id = connectionId;
            line.style.width = `${length}px`;
            line.style.left = `${x1}px`;
            line.style.top = `${y1}px`;
            line.style.transform = `rotate(${angle}deg)`;
            line.style.zIndex = '1';
            
            connectionsContainer.appendChild(line);
        }
        
        function removePairHandler(event) {
            const item = event.currentTarget;
            const connectionId = item.dataset.connectionId;
            
            if (connectionId) {
                removeMatchingPair(connectionId);
            }
        }
        
        function removeMatchingPair(connectionId) {
            const line = document.getElementById(connectionId);
            if (line) line.remove();
            
            const { item1, item2 } = connectionLines[connectionId];
            item1.classList.remove('paired', 'matched');
            item2.classList.remove('paired', 'matched');
            
            delete item1.dataset.connectionId;
            delete item2.dataset.connectionId;
            
            item1.removeEventListener('click', removePairHandler);
            item2.removeEventListener('click', removePairHandler);
            
            // Remove from challengeAnswers
            const leftItem = item1.closest('.matching-column:first-child') ? item1 : item2;
            delete challengeAnswers.matching[leftItem.dataset.id];
            
            delete connectionLines[connectionId];
        }

        // Answer Checking Functions
        function checkQuizAnswers(challengeNum) {
            const correctAnswers = selectedQuestions.rapidFire.map(q => q.a);
            const userAnswers = challengeAnswers.quiz1;
            
            let score = 0;
            let total = correctAnswers.length;
            
            document.querySelectorAll('#challenge1 .explanation-panel').forEach(el => el.remove());
            
            for (let i = 0; i < total; i++) {
                const questionElement = document.querySelectorAll('#challenge1 .quiz-question')[i];
                const options = questionElement.querySelectorAll('.quiz-option');
                const question = selectedQuestions.rapidFire[i];
                
                if (userAnswers[i] === correctAnswers[i]) {
                    score++;
                    options.forEach(opt => {
                        if (opt.classList.contains('selected')) {
                            opt.classList.add('correct');
                        }
                    });
                    
                    const explanation = document.createElement('div');
                    explanation.className = 'explanation-panel active';
                    explanation.innerHTML = `
                        <div class="explanation-title"><i class="fas fa-check-circle" style="color: #10b981;"></i> Question ${i + 1}: Correct!</div>
                        <div class="explanation-content">${question.explanation}</div>
                    `;
                    questionElement.appendChild(explanation);
                } else {
                    options.forEach(opt => {
                        if (opt.classList.contains('selected')) {
                            opt.classList.add('incorrect');
                        }
                    });
                    
                    const explanation = document.createElement('div');
                    explanation.className = 'explanation-panel active';
                    explanation.innerHTML = `
                        <div class="explanation-title"><i class="fas fa-times-circle" style="color: #ef4444;"></i> Question ${i + 1}: Incorrect</div>
                        <div class="explanation-content">
                            <strong>Correct Answer:</strong> ${correctAnswers[i] ? 'True' : 'False'}<br>
                            <strong>Explanation:</strong> ${question.explanation}
                        </div>
                    `;
                    questionElement.appendChild(explanation);
                }
            }
            
            const feedback = document.getElementById('challenge1-feedback');
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `üéâ Perfect! You got all ${score}/${total} questions correct!`;
                markChallengeComplete(1, 100);
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `You got ${score}/${total} correct. Review the explanations below each question!`;
            }
        }

        function checkAdvancedAnswers() {
            const correctAnswers = selectedQuestions.advancedConcepts.map(q => q.correct);
            const userAnswers = challengeAnswers.advanced;
            
            let score = 0;
            let total = correctAnswers.length;
            
            for (let i = 0; i < total; i++) {
                const questionElement = document.querySelectorAll('#challenge4 .quiz-question')[i];
                const options = questionElement.querySelectorAll('.quiz-option');
                const question = selectedQuestions.advancedConcepts[i];
                
                if (userAnswers[i] === correctAnswers[i]) {
                    score++;
                    options.forEach(opt => {
                        if (opt.classList.contains('selected')) {
                            opt.classList.add('correct');
                        }
                    });
                } else {
                    options.forEach(opt => {
                        if (opt.classList.contains('selected')) {
                            opt.classList.add('incorrect');
                            if (question.wrongExplanations && question.wrongExplanations[opt.textContent]) {
                                const wrongExplanation = document.createElement('div');
                                wrongExplanation.className = 'wrong-answer-explanation';
                                wrongExplanation.innerHTML = `<strong>Why this is wrong:</strong> ${question.wrongExplanations[opt.textContent]}`;
                                opt.appendChild(wrongExplanation);
                            }
                        }
                    });
                }
                
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'explanation-panel active';
                explanationDiv.innerHTML = `
                    <div class="explanation-title">
                        <i class="fas fa-lightbulb"></i> 
                        ${userAnswers[i] === correctAnswers[i] ? 'Excellent!' : 'Learning Opportunity'}
                    </div>
                    <div class="explanation-content">
                        <strong>Correct Answer:</strong> ${correctAnswers[i]}<br>
                        <strong>Explanation:</strong> ${question.explanation}
                    </div>
                `;
                questionElement.appendChild(explanationDiv);
            }
            
            const feedback = document.getElementById('challenge4-feedback');
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.textContent = `üéâ Outstanding! You've mastered the advanced concepts!`;
                markChallengeComplete(4, 180);
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.textContent = `You got ${score}/${total} correct. Study the detailed explanations below each question!`;
            }
        }

        function checkFillBlanks() {
            let totalBlanks = 0;
            let correctBlanks = 0;
            let explanationHTML = '';
            
            challengeAnswers.fillBlanks.forEach((questionBlanks, qIndex) => {
                const question = selectedQuestions.fillInTheBlanks[qIndex];
                let questionCorrect = true;
                
                questionBlanks.forEach(blank => {
                    totalBlanks++;
                    const input = document.getElementById(blank.id);
                    const userAnswer = input.value.toLowerCase().trim();
                    
                    if (userAnswer === blank.correctAnswer.toLowerCase()) {
                        correctBlanks++;
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                    } else {
                        questionCorrect = false;
                        input.classList.remove('correct');
                        input.classList.add('incorrect');
                    }
                });
                
                explanationHTML += `<div class="explanation-panel active">
                    <div class="explanation-title">
                        <i class="fas fa-${questionCorrect ? 'check-circle' : 'info-circle'}"></i> 
                        Question ${qIndex + 1} ${questionCorrect ? 'Complete!' : 'Review'}
                    </div>
                    <div class="explanation-content">`;
                
                Object.keys(question.answers).forEach(blankKey => {
                    const explanation = question.explanations[blankKey];
                    explanationHTML += `<strong>${blankKey}:</strong> ${question.answers[blankKey]} - ${explanation}<br>`;
                });
                
                explanationHTML += `<br><strong>Hint:</strong> ${question.hint}</div></div>`;
            });
            
            const feedback = document.getElementById('challenge2-feedback');
            feedback.innerHTML = explanationHTML;
            
            if (correctBlanks === totalBlanks) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Excellent! You completed all fill-in-the-blanks correctly!<br><br>` + explanationHTML;
                markChallengeComplete(2, 150);
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${correctBlanks}/${totalBlanks} correct. Check the explanations below:<br><br>` + explanationHTML;
            }
        }

        function checkCalculations() {
            let totalBlanks = 0;
            let correctBlanks = 0;
            let explanationHTML = '';
            
            challengeAnswers.calculations.forEach((questionBlanks, qIndex) => {
                const question = selectedQuestions.calculations[qIndex];
                let questionCorrect = true;
                
                questionBlanks.forEach(blank => {
                    totalBlanks++;
                    const input = document.getElementById(blank.id);
                    const userAnswer = input.value.toLowerCase().trim();
                    
                    let isCorrect = false;
                    
                    if (!isNaN(parseFloat(userAnswer)) && !isNaN(parseFloat(blank.correctAnswer))) {
                        const userNum = parseFloat(userAnswer);
                        const correctNum = parseFloat(blank.correctAnswer);
                        const tolerance = blank.tolerance || 0;
                        isCorrect = Math.abs(userNum - correctNum) <= tolerance;
                    } else {
                        isCorrect = userAnswer === blank.correctAnswer.toLowerCase();
                    }
                    
                    if (isCorrect) {
                        correctBlanks++;
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                    } else {
                        questionCorrect = false;
                        input.classList.remove('correct');
                        input.classList.add('incorrect');
                    }
                });
                
                explanationHTML += `<div class="explanation-panel active">
                    <div class="explanation-title">
                        <i class="fas fa-${questionCorrect ? 'check-circle' : 'calculator'}"></i> 
                        Problem ${qIndex + 1} ${questionCorrect ? 'Solved!' : 'Solution'}
                    </div>
                    <div class="explanation-content">
                        <strong>Solution:</strong> ${question.explanation}<br>
                        <strong>Hint:</strong> ${question.hint}
                    </div>
                </div>`;
            });
            
            const feedback = document.getElementById('challenge5-feedback');
            if (correctBlanks === totalBlanks) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Perfect calculations! You understand the quantitative aspects of BJTs!<br><br>` + explanationHTML;
                markChallengeComplete(5, 200);
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${correctBlanks}/${totalBlanks} calculations correct. Study the solutions below:<br><br>` + explanationHTML;
            }
        }

        function checkMatching() {
            const totalMatches = 4;
            const completedMatches = Object.keys(challengeAnswers.matching).length;
            
            // Define correct matches
            const correctMatches = {
                'cutoff': 'def-cutoff',
                'saturation': 'def-saturation',
                'early': 'def-early',
                'beta': 'def-beta'
            };
            
            let correctCount = 0;
            let allCorrect = true;
            
            // Check each connection
            for (const [connId, {item1, item2}] of Object.entries(connectionLines)) {
                const id1 = item1.dataset.id;
                const id2 = item2.dataset.id;
                
                const isCorrect = (correctMatches[id1] === id2) || (correctMatches[id2] === id1);
                
                if (isCorrect) {
                    item1.classList.add('correct-match');
                    item2.classList.add('correct-match');
                    correctCount++;
                } else {
                    item1.classList.add('incorrect-match');
                    item2.classList.add('incorrect-match');
                    allCorrect = false;
                }
            }
            
            let explanationHTML = `<div class="explanation-panel active">
                <div class="explanation-title"><i class="fas fa-link"></i> Matching Explanations</div>
                <div class="explanation-content">
                    <strong>Cutoff Mode ‚Üî Both junctions reverse biased:</strong> In cutoff, the BJT is 'off' with both BE and BC junctions reverse biased, resulting in very small leakage currents.<br><br>
                    <strong>Saturation Mode ‚Üî Both junctions forward biased:</strong> In saturation, both junctions are forward biased, the BJT is fully 'on', and VCE is very small.<br><br>
                    <strong>Early Effect ‚Üî Output resistance effect in BJTs:</strong> The Early effect describes how IC slightly increases with VCE in active mode due to base width modulation.<br><br>
                    <strong>Current Gain (Œ≤) ‚Üî Ratio of collector to base current:</strong> Beta is the fundamental parameter that describes current amplification: Œ≤ = IC/IB.
                </div>
            </div>`;
            
            const feedback = document.getElementById('challenge3-feedback');
            if (completedMatches === totalMatches && allCorrect) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Perfect matching! You've correctly paired all terms with their definitions!<br><br>` + explanationHTML;
                markChallengeComplete(3, 120);
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You've matched ${correctCount}/${totalMatches} pairs correctly. Review the explanations below:<br><br>` + explanationHTML;
            }
        }

        // Hint Functions
        function showQuizHints(challengeNum) {
            const hintContainer = document.getElementById(`challenge${challengeNum}-hint`);
            let hintsHTML = '<strong>üí° Hints for each question:</strong><br><br>';
            
            selectedQuestions.rapidFire.forEach((question, index) => {
                hintsHTML += `<div class="concept-box">
                    <strong>Question ${index + 1}:</strong> ${question.hint}
                </div>`;
            });
            
            hintContainer.innerHTML = hintsHTML;
            hintContainer.classList.add('active');
        }

        function showAdvancedHints() {
            const hintContainer = document.getElementById('challenge4-hint');
            let hintsHTML = '<strong>üí° Advanced Concept Hints:</strong><br><br>';
            
            selectedQuestions.advancedConcepts.forEach((question, index) => {
                hintsHTML += `<div class="concept-box">
                    <strong>Question ${index + 1}:</strong> ${question.hint}
                </div>`;
            });
            
            hintContainer.innerHTML = hintsHTML;
            hintContainer.classList.add('active');
        }

        function showMatchingHints() {
            const hintContainer = document.getElementById('challenge3-hint');
            hintContainer.innerHTML = `
                <strong>üí° Matching Hints:</strong><br><br>
                <div class="concept-box">
                    <strong>Cutoff Mode:</strong> Think about when the BJT is completely 'off' - what happens to both junctions?
                </div>
                <div class="concept-box">
                    <strong>Saturation Mode:</strong> This is when the BJT is fully 'on' - both junctions conduct.
                </div>
                <div class="concept-box">
                    <strong>Early Effect:</strong> This describes how the output isn't perfectly flat in I-V characteristics.
                </div>
                <div class="concept-box">
                    <strong>Current Gain (Œ≤):</strong> This is the fundamental amplification parameter of a BJT.
                </div>
            `;
            hintContainer.classList.add('active');
        }

        function showFillBlanksHint() {
            const feedback = document.getElementById('challenge2-feedback');
            feedback.className = 'challenge-feedback';
            feedback.style.display = 'block';
            
            let hintHTML = '<strong>üí° Comprehensive Hints:</strong><br><br>';
            selectedQuestions.fillInTheBlanks.forEach((question, index) => {
                hintHTML += `<div class="concept-box">
                    <strong>Question ${index + 1} Hint:</strong> ${question.hint}<br>
                `;
                Object.keys(question.explanations).forEach(key => {
                    hintHTML += `‚Ä¢ ${key}: ${question.explanations[key]}<br>`;
                });
                hintHTML += `</div>`;
            });
            
            feedback.innerHTML = hintHTML;
        }

        function showCalculationHint() {
            const feedback = document.getElementById('challenge5-feedback');
            feedback.className = 'challenge-feedback';
            feedback.style.display = 'block';
            
            let hintHTML = '<strong>üí° Formula Hints and Solutions:</strong><br><br>';
            selectedQuestions.calculations.forEach((question, index) => {
                hintHTML += `<div class="concept-box">
                    <strong>Problem ${index + 1}:</strong><br>
                    <strong>Hint:</strong> ${question.hint}<br>
                    <strong>Approach:</strong> ${question.explanation}
                </div>`;
            });
            
            feedback.innerHTML = hintHTML;
        }

        // Challenge Management Functions
        function markChallengeComplete(challengeNum, points) {
            if (!challengeStates[challengeNum]) {
                challengeStates[challengeNum] = true;
                
                const challengeSection = document.getElementById(`challenge${challengeNum}`);
                challengeSection.classList.add('completed');
                
                updateChallengeStats();
            }
        }

        function resetChallenge(challengeNum) {
            challengeStates[challengeNum] = false;
            const challengeSection = document.getElementById(`challenge${challengeNum}`);
            challengeSection.classList.remove('completed');
            
            challengeSection.querySelectorAll('.explanation-panel, .question-explanation, .wrong-answer-explanation').forEach(el => el.remove());
            
            switch(challengeNum) {
                case 1:
                    challengeAnswers.quiz1 = new Array(selectedQuestions.rapidFire.length).fill(null);
                    challengeSection.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect');
                    });
                    break;
                case 2:
                    challengeSection.querySelectorAll('.fill-blank-input').forEach(input => {
                        input.value = '';
                        input.classList.remove('correct', 'incorrect');
                    });
                    break;
                case 3:
                    resetMatching();
                    break;
                case 4:
                    challengeAnswers.advanced = new Array(selectedQuestions.advancedConcepts.length).fill(null);
                    challengeSection.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect');
                    });
                    break;
                case 5:
                    challengeAnswers.calculations = [];
                    challengeSection.querySelectorAll('.fill-blank-input').forEach(input => {
                        input.value = '';
                        input.classList.remove('correct', 'incorrect');
                    });
                    break;
            }
            
            const feedback = document.getElementById(`challenge${challengeNum}-feedback`);
            const hint = document.getElementById(`challenge${challengeNum}-hint`);
            if (feedback) feedback.style.display = 'none';
            if (hint) hint.classList.remove('active');
            
            updateChallengeStats();
        }

        function resetMatching() {
            const connectionsContainer = document.getElementById('matchingConnections');
            connectionsContainer.innerHTML = '';
            
            document.querySelectorAll('.matching-item').forEach(item => {
                item.classList.remove('selected', 'matched', 'paired', 'correct-match', 'incorrect-match');
                delete item.dataset.connectionId;
                item.removeEventListener('click', removePairHandler);
            });
            
            connectionLines = {};
            selectedMatchingItems = [];
            challengeAnswers.matching = {};
        }

        function updateChallengeStats() {
            const completed = Object.values(challengeStates).filter(state => state).length;
            const total = Object.keys(challengeStates).length;
            const score = completed * 50; // 50 points per challenge
            
            document.getElementById('completedChallenges').textContent = completed;
            document.getElementById('challengeScore').textContent = score;
            
            const progressPercent = (completed / total) * 100;
            document.getElementById('overallProgress').style.width = `${progressPercent}%`;
            
            if (completed === total) {
                setTimeout(() => {
                    showAllChallengesComplete(score);
                }, 1000);
            }
        }

        function resetAllChallenges() {
            Object.keys(challengeStates).forEach(key => {
                challengeStates[key] = false;
                const challengeSection = document.getElementById(`challenge${key}`);
                challengeSection.classList.remove('completed');
                
                challengeSection.querySelectorAll('.explanation-panel, .question-explanation, .wrong-answer-explanation').forEach(el => el.remove());
                
                const feedback = document.getElementById(`challenge${key}-feedback`);
                const hint = document.getElementById(`challenge${key}-hint`);
                if (feedback) feedback.style.display = 'none';
                if (hint) hint.classList.remove('active');
            });
            
            selectRandomQuestions();
            initializeChallengeAnswers();
            generateAllChallenges();
            
            selectedMatchingItems.length = 0;
            challengeAnswers.matching = {};
            
            updateChallengeStats();
            
            console.log('All challenges reset with new random questions!');
        }

        function showAllChallengesComplete(finalScore) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100003;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.5s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    max-width: 500px;
                    margin: 20px;
                    animation: popIn 0.6s ease-out;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                    <h2 style="
                        font-size: 2rem;
                        font-weight: 700;
                        color: #1f2937;
                        margin-bottom: 15px;
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        background-clip: text;
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">
                        üéâ BJT Master! üéâ
                    </h2>
                    <p style="
                        color: #4b5563;
                        font-size: 1.1rem;
                        line-height: 1.6;
                        margin-bottom: 25px;
                    ">
                        Congratulations! You've successfully completed all 5 BJT physics challenges and mastered transistor fundamentals with detailed explanations!
                    </p>
                    <div style="
                        background: #f8fafc;
                        border-radius: 12px;
                        padding: 20px;
                        margin: 20px 0;
                        border-left: 4px solid #6366f1;
                    ">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1; margin-bottom: 10px;">
                            Final Score: ${finalScore} Points
                        </div>
                        <div style="color: #6b7280;">
                            ‚≠ê Complete understanding of BJT operating modes<br>
                            ‚≠ê Mastery of current-voltage relationships<br>
                            ‚≠ê Advanced knowledge of temperature and Early effects<br>
                            ‚≠ê Excellent problem-solving skills<br>
                            ‚≠ê Deep comprehension of amplifier circuits<br>
                            ‚≠ê Ready for advanced analog electronics!
                        </div>
                    </div>
                    <button onclick="closeCompletionModal()" style="
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: all 0.2s;
                        margin-top: 20px;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        üöÄ Continue Learning
                    </button>
                </div>
            `;
            
            modal.id = 'challengeCompletionModal';
            document.body.appendChild(modal);
            
            createConfetti();
        }

        function closeCompletionModal() {
            const modal = document.getElementById('challengeCompletionModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        top: -10px;
                        left: ${Math.random() * 100}%;
                        width: 10px;
                        height: 10px;
                        background: ${['#6366f1', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444'][Math.floor(Math.random() * 5)]};
                        z-index: 100004;
                        animation: fall ${2 + Math.random() * 3}s linear forwards;
                        transform: rotate(${Math.random() * 360}deg);
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        // Utility and UI Functions
        // Tour steps with detailed explanations for BJT simulation
        const tourSteps = [
            {
                title: "Welcome to BJT Interactive Lab",
                content: "Welcome to the BJT Interactive Physics Lab! This guided tour will walk you through all the features of this simulation, explaining BJT physics, operating modes, and applications. Click 'Next' to begin your journey through bipolar junction transistor technology.",
                target: ".container",
                position: "center"
            },
            {
                title: "BJT Structure & Regions",
                content: "The BJT (Bipolar Junction Transistor) consists of three semiconductor regions: the Emitter (heavily doped to supply carriers), the Base (thin, lightly doped region), and the Collector (moderately doped region that collects carriers). The visualization shows an NPN transistor with p-type material sandwiched between two n-type regions.",
                target: ".bjt-structure",
                position: "right"
            },
            {
                title: "Base-Emitter Junction",
                content: "The Base-Emitter junction is crucial for BJT operation. When forward-biased (typically >0.7V for silicon), it allows electrons to flow from the emitter into the base, forming the base current (IB). Most of these electrons continue to the collector due to the thin base region.",
                target: ".bjt-layer.base-region",
                position: "right",
                spotlight: { width: 100, height: 100 }
            },
            {
                title: "Collector Current Control",
                content: "The key feature of a BJT is current amplification. A small base current controls a much larger collector current. The ratio IC/IB is called Œ≤ (beta) or hFE, typically between 50-300 for most transistors. This is why BJTs are called 'current-controlled devices'.",
                target: ".bjt-layer.collector-region",
                position: "left"
            },
            {
                title: "Bias Voltage Controls",
                content: "These sliders control the bias voltages applied to the BJT. VBE (Base-Emitter Voltage) controls whether the transistor is ON (>0.7V) or OFF (<0.7V). VCE (Collector-Emitter Voltage) affects the operating region of the transistor in its ON state.",
                target: "#vbe-voltage",
                position: "left"
            },
            {
                title: "VCE Control and Impact",
                content: "The VCE slider controls the Collector-Emitter voltage. This voltage is crucial because: 1) In saturation mode (VCE < ~0.3V), the BJT acts as a closed switch, 2) In active mode (VCE > ~0.3V), the BJT acts as an amplifier. Try adjusting VCE and observe how the currents and operating mode change. Higher VCE values also cause the Early Effect, slightly increasing collector current even in active mode.",
                target: "#vce-voltage",
                position: "left"
            },
            {
                title: "Operating Modes",
                content: "A BJT operates in different modes: Cutoff (both junctions reverse-biased, no current flow), Active (BE forward-biased, BC reverse-biased, transistor acts as amplifier), and Saturation (both junctions forward-biased, maximum current flow). The 'Operating Mode' indicator shows the current state.",
                target: "#mode-indicator",
                position: "right"
            },
            {
                title: "Real-time Current Measurements",
                content: "These displays show the three currents in a BJT: Base Current (IB), Collector Current (IC), and Emitter Current (IE). According to Kirchhoff's Current Law, IE = IB + IC. In active mode, IC is approximately Œ≤ times IB.",
                target: ".measurements-section",
                position: "top"
            },
            {
                title: "I-V Characteristics",
                content: "The I-V Characteristics tab shows various graphs of BJT behavior. These graphs are essential for understanding BJT behavior in circuits and for designing BJT-based amplifiers and switches. Let's explore each graph in detail in the following steps.",
                target: "button[onclick=\"switchTab(this, 'characteristics')\"]",
                position: "bottom",
                action: function() {
                    document.querySelector("button[onclick=\"switchTab(this, 'characteristics')\"]").click();
                }
            },
            {
                title: "Output Characteristics Curve",
                content: "The output characteristics show how collector current (IC) varies with collector-emitter voltage (VCE) for different base currents (IB). Note the distinct regions: active (flat regions) where the BJT acts as an amplifier, and saturation (steep rise near origin) where the BJT acts as a switch. Each curve represents a different IB value, with higher IB producing higher IC.",
                target: "#output-characteristics",
                position: "right"
            },
            {
                title: "Output Characteristics - Active Region",
                content: "In the active region (right portion of each curve), IC remains nearly constant for increasing VCE at a given IB. This is the amplification region where small changes in IB produce proportional changes in IC. The BJT's current gain (Œ≤) can be calculated as IC/IB in this region. Notice how the curves are almost horizontal but not quite - this slight slope is due to the Early Effect.",
                target: "#output-characteristics",
                position: "right"
            },
            {
                title: "Output Characteristics - Saturation Region",
                content: "In the saturation region (left portion where curves rise steeply), both the base-emitter and base-collector junctions are forward-biased. The BJT acts as a closed switch with minimal VCE (typically <0.2V). This region is used in digital circuits and switching applications. The boundary between saturation and active regions is where VBC ‚âà 0V.",
                target: "#output-characteristics",
                position: "right"
            },
            {
                title: "Early Effect",
                content: "In the active region, you can observe the slight upward slope in the IC vs VCE curves. This is the Early Effect, caused by base width modulation with changing VCE. As VCE increases, the base-collector depletion region widens, effectively narrowing the base width. This creates a finite output resistance in the BJT, affecting amplifier performance. The extrapolated intersection of these curves on the negative VCE axis is called the Early Voltage (VA).",
                target: "#output-characteristics",
                position: "right"
            },
            {
                title: "Input Characteristics",
                content: "The input characteristics show how base current (IB) varies with base-emitter voltage (VBE) for different VCE values. Note the exponential relationship - this is the diode-like behavior of the base-emitter junction. The threshold voltage (around 0.7V for silicon BJTs) is clearly visible, below which almost no current flows. Above this threshold, IB increases exponentially with small increases in VBE, following the diode equation: IB ‚àù e^(VBE/VT), where VT is the thermal voltage (‚âà26mV at room temperature).",
                target: "#input-characteristics",
                position: "left"
            },
            {
                title: "Transfer Characteristics",
                content: "The transfer characteristics show the relationship between collector current (IC) and base current (IB) for different VCE values. The slope of these curves represents the current gain (Œ≤ or hFE) of the transistor. In the active region, the relationship is almost linear, showing that IC = Œ≤ √ó IB. However, at high currents, the gain decreases due to high-level injection effects. This graph is particularly useful for determining the DC current gain of the transistor under different operating conditions.",
                target: "#transfer-characteristics",
                position: "right"
            },
            {
                title: "Temperature Characteristics",
                content: "This graph shows how BJT behavior changes with temperature. As temperature increases: 1) VBE decreases by about -2mV/¬∞C, 2) Leakage current (ICBO) doubles approximately every 10¬∞C, 3) Current gain (Œ≤) increases. These temperature effects are crucial for designing circuits that operate across temperature ranges. Thermal runaway is a potential issue in power BJTs where increased temperature causes increased current, leading to further heating in a positive feedback loop.",
                target: "#temperature-characteristics",
                position: "left"
            },
            {
                title: "Temperature Effects In-Depth",
                content: "Temperature has significant impacts on BJT operation: 1) VBE threshold decreases with temperature, causing devices to turn on at lower voltages when hot, 2) Collector-Base leakage current (ICBO) increases exponentially with temperature, doubling every 10¬∞C, 3) At higher temperatures, minority carrier mobility decreases but carrier concentration increases more significantly, resulting in a net increase in current gain, 4) Silicon BJTs typically operate from -55¬∞C to +150¬∞C, while germanium devices have a more limited range (-40¬∞C to +85¬∞C).",
                target: "#temperature-characteristics",
                position: "left"
            },
            {
                title: "Common Emitter Amplifier",
                content: "Let's explore the Common Emitter (CE) amplifier - the most widely used BJT configuration. The CE amplifier provides good voltage gain and current gain, making it ideal for various amplification applications.",
                target: "button[onclick=\"switchTab(this, 'amplifier')\"]",
                position: "bottom",
                action: function() {
                    document.querySelector("button[onclick=\"switchTab(this, 'amplifier')\"]").click();
                }
            },
            {
                title: "CE Amplifier Circuit",
                content: "This is the standard CE amplifier circuit. Note the key components: biasing resistors (to set the Q-point), coupling capacitors (to block DC but pass AC), and the collector resistor RC (which determines the voltage gain).",
                target: ".static-ce-amplifier",
                position: "right"
            },
            {
                title: "Waveform Simulation",
                content: "This interactive simulation shows how the CE amplifier processes signals. The input sine wave is amplified and inverted (180¬∞ phase shift) at the output. The key characteristic of CE amplifiers is this voltage inversion.",
                target: ".waveform-simulation",
                position: "top"
            },
            {
                title: "Simulation Controls",
                content: "Adjust these controls to see how the amplifier responds to different input signals. Try changing the amplitude, frequency, and gain to observe the amplifier's behavior under various conditions.",
                target: ".simulation-controls",
                position: "bottom"
            },
            {
                title: "CE Amplifier Theory",
                content: "This section summarizes the key characteristics of CE amplifiers: high voltage gain (50-200), 180¬∞ phase shift, moderate input and output impedance. Understanding these properties is crucial for designing effective amplifier circuits.",
                target: ".controls-panel",
                position: "left"
            },
            {
                title: "Knowledge Challenges",
                content: "Test your understanding of BJT concepts with these interactive challenges. They include multiple-choice questions, fill-in-the-blanks exercises, and circuit analysis problems to reinforce your learning.",
                target: "button[onclick=\"switchTab(this, 'challenges')\"]",
                position: "bottom",
                action: function() {
                    document.querySelector("button[onclick=\"switchTab(this, 'challenges')\"]").click();
                }
            },
            {
                title: "Tour Complete!",
                content: "Congratulations! You've completed the guided tour of the BJT Interactive Lab. You now understand the basic structure, operation, and applications of Bipolar Junction Transistors. Feel free to explore all the features of the simulation and test your knowledge with the challenges. Click 'Finish' to end the tour.",
                target: ".container",
                position: "center"
            }
        ];

        // Tour Functions
        function startGuidedTour() {
            tourActive = true;
            currentTourStep = 0;
            
            // Show tour elements
            document.getElementById('tourOverlay').classList.add('active');
            document.getElementById('tourPopup').classList.add('active');
            
            // Make sure we're on the simulation tab to start
            if (currentTab !== 'simulation') {
                document.querySelector("button[onclick=\"switchTab(this, 'simulation')\"]").click();
            }
            
            // Make all interactive elements remain interactive
            document.querySelectorAll('button, input, select, a, .slider, .control-knob')
                .forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
            
            showTourStep();
        }

        function showTourStep() {
            if (currentTourStep >= tourSteps.length) {
                endTour();
                return;
            }
            
            const step = tourSteps[currentTourStep];
            
            // Update tour popup content
            document.getElementById('tourStepNumber').textContent = currentTourStep + 1;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourContent').innerHTML = step.content;
            
            // Update progress bar
            const progressPercent = ((currentTourStep + 1) / tourSteps.length) * 100;
            document.getElementById('tourProgressBar').style.width = `${progressPercent}%`;
            
            // Update button states
            document.getElementById('tourPrevBtn').disabled = currentTourStep === 0;
            
            if (currentTourStep === tourSteps.length - 1) {
                document.getElementById('tourNextBtn').textContent = 'Finish';
            } else {
                document.getElementById('tourNextBtn').textContent = 'Next';
            }
            
            // Position spotlight and popup
            positionTourElements(step);
            
            // Execute step action if any
            if (step.action && typeof step.action === 'function') {
                setTimeout(() => {
                    step.action();
                    // Reposition after action
                    setTimeout(() => positionTourElements(step), 300);
                }, 500);
            }
        }

        function positionTourElements(step) {
            const target = document.querySelector(step.target);
            if (!target) return;
            
            const spotlight = document.getElementById('tourSpotlight');
            const popup = document.getElementById('tourPopup');
            
            // Position the spotlight
            const targetRect = target.getBoundingClientRect();
            
            // Set spotlight size (default or custom)
            const spotlightWidth = step.spotlight ? step.spotlight.width : targetRect.width + 20;
            const spotlightHeight = step.spotlight ? step.spotlight.height : targetRect.height + 20;
            
            // Auto-scroll when explaining the lower two graphs
            if (step.target === "#input-characteristics" || step.target === "#transfer-characteristics") {
                // First scroll to make the graph fully visible
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // After scrolling completes, update the spotlight position
                setTimeout(() => {
                    // Get updated position after scrolling
                    const updatedRect = target.getBoundingClientRect();
                    
                    spotlight.style.width = `${spotlightWidth}px`;
                    spotlight.style.height = `${spotlightHeight}px`;
                    spotlight.style.left = `${updatedRect.left + (updatedRect.width - spotlightWidth) / 2}px`;
                    spotlight.style.top = `${updatedRect.top + (updatedRect.height - spotlightHeight) / 2}px`;
                }, 500); // Wait for scroll animation to complete
            } else {
                // For other steps, position the spotlight immediately
                spotlight.style.width = `${spotlightWidth}px`;
                spotlight.style.height = `${spotlightHeight}px`;
                spotlight.style.left = `${targetRect.left + (targetRect.width - spotlightWidth) / 2}px`;
                spotlight.style.top = `${targetRect.top + (targetRect.height - spotlightHeight) / 2}px`;
            }
            
            // Make target element interactive
            target.style.pointerEvents = 'auto';
            
            // Position the popup based on position property
            const popupRect = popup.getBoundingClientRect();
            
            // Function to position the popup
            const positionPopup = (rect) => {
                // Default positions
                let left = 0;
                let top = 0;
                
                switch(step.position) {
                    case 'left':
                        left = rect.left - popupRect.width - 20;
                        top = rect.top + (rect.height - popupRect.height) / 2;
                        break;
                    case 'right':
                        left = rect.right + 20;
                        top = rect.top + (rect.height - popupRect.height) / 2;
                        break;
                    case 'top':
                        left = rect.left + (rect.width - popupRect.width) / 2;
                        top = rect.top - popupRect.height - 20;
                        break;
                    case 'bottom':
                        left = rect.left + (rect.width - popupRect.width) / 2;
                        top = rect.bottom + 20;
                        break;
                    case 'center':
                    default:
                        left = (window.innerWidth - popupRect.width) / 2;
                        top = (window.innerHeight - popupRect.height) / 2;
                        break;
                }
                
                // Ensure popup stays within viewport
                left = Math.max(20, Math.min(left, window.innerWidth - popupRect.width - 20));
                top = Math.max(20, Math.min(top, window.innerHeight - popupRect.height - 20));
                
                popup.style.left = `${left}px`;
                popup.style.top = `${top}px`;
            };
            
            // If this is for the lower graphs, wait for scrolling to complete before positioning the popup
            if (step.target === "#input-characteristics" || step.target === "#transfer-characteristics") {
                setTimeout(() => {
                    // Get updated position after scrolling
                    const updatedRect = target.getBoundingClientRect();
                    positionPopup(updatedRect);
                }, 500);
            } else {
                // For other steps, position the popup immediately
                positionPopup(targetRect);
            }
        }

        function nextTourStep() {
            currentTourStep++;
            showTourStep();
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep();
            }
        }

        function skipTour() {
            // Immediately end the tour without confirmation for better user experience
            endTour();
            
            // Ensure any potential leftover tour elements are hidden
            document.querySelectorAll('.tour-spotlight, .tour-popup, .tour-overlay, .tour-spotlight-secondary').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
        }

        function endTour() {
            tourActive = false;
            
            // Hide tour elements
            const tourOverlay = document.getElementById('tourOverlay');
            const tourPopup = document.getElementById('tourPopup');
            const tourSpotlight = document.getElementById('tourSpotlight');
            
            // Remove active classes
            tourOverlay.classList.remove('active');
            tourPopup.classList.remove('active');
            
            // Ensure elements are hidden with inline styles as a fallback
            tourOverlay.style.display = 'none';
            tourPopup.style.display = 'none';
            tourSpotlight.style.display = 'none';
            
            // Reset any pointer-events styles we set
            document.querySelectorAll('*').forEach(el => {
                if (el.style.pointerEvents === 'auto') {
                    el.style.pointerEvents = '';
                }
            });
            
            // Return to simulation tab
            if (currentTab !== 'simulation') {
                document.querySelector("button[onclick=\"switchTab(this, 'simulation')\"]").click();
            }
        }

        function toggleHelp() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanelVisible = !helpPanelVisible;
            
            if (helpPanelVisible) {
                helpPanel.classList.add('active');
            } else {
                helpPanel.classList.remove('active');
            }
        }

        // Auto-start the guided tour after a short delay
        setTimeout(() => {
            startGuidedTour();
        }, 1000);

        console.log('Enhanced BJT Interactive Lab with Comprehensive Challenges initialized successfully!');
    </script>
</body>
</html>